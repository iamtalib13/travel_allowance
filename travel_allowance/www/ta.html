<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travel Allowance</title>

    <!--HTMX Link-->
    <script src="https://unpkg.com/htmx.org@2.0.1"></script>

    <!-- Bootstrap CSS (replace with your version if necessary) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!--Include the Flatpickr CSS and JS:
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>-->

    <style>
      body {
        font-family: Arial, sans-serif;
        /*font-family: 'lato', sans-serif;*/
        /*  overflow: hidden; Prevent the page from having a scrollbar */
        margin: 0;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .ta-container {
        margin: 0;
        padding: 0;
      }

      /****** Navbar style css  ********/
      .ta-nav {
        position: sticky;
        top: 0; /* Ensures it sticks to the top of the viewport */
        background: linear-gradient(
          to right,
          rgba(0, 128, 222, 1),
          rgba(97, 202, 255, 1)
        );
        color: #ffffff;
        padding: 8px 20px;
        margin: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap;
        z-index: 1000; /* Ensures it stays above other content */
      }
      a.ta-home {
        font-size: larger;
        font-weight: bold;
        padding: 0 10px;
        text-decoration: none;
        color: #fff;
      }
      a.ta-heading {
        font-size: 20px;
        font-weight: bold;
        text-decoration: none;
        color: #fff;
      }
      a.user-details {
        display: flex;
        text-decoration: none;
        color: #fff;
        cursor: pointer;
      }
      .user-info {
        display: block;
        text-align: end;
      }
      .user-icon {
        margin: 0 5px;
      }
      .current-user {
        font-size: large;
        font-weight: bold;
        padding: 0;
        margin: 0;
      }
      .user-designation {
        padding: 0;
        margin: 0;
      }
      .logout-btn {
        padding: 5px 10px;
        background-color: #fff;
        color: #000;
        position: relative;
        cursor: pointer;
      }
      .logout-btn:active {
        background-color: transparent;
      }
      .logout-btn:hover {
        background-color: #e9ecef;
      }

      .nav-link .count {
        background-color: rgb(221, 51, 51);
        color: white;
        border-radius: 50%;
        padding: 4px 12px;
        font-size: 0.8em;
        position: relative;
        display: inline-block;
        font-size: 16px;
        font-weight: bold;
        /*border: 2px solid #bf1818;*/
      }

      /****** TA form CSS  *******/
      .field-error {
        border: 1px solid red;
        color: red;
        background-color: #fff5f5;
      }

      .field-error::placeholder {
        color: red; /* Ensure the placeholder text also turns red */
      }

      .description {
        font-size: 12px;
      }

      /********TA form Save Button********/
      .add-button {
        padding: 6px 16px;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: large;
        font-weight: 700;
        margin-top: 12px;
        background-color: #286840;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      .add-button:hover {
        background-color: #2f7a4c;
        transform: scale(1.05);
      }

      .form-select:focus,
      .form-control:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: none;
      }
      .form-check-input {
        border-color: rgb(58, 58, 58);
      }
      .form-check-input:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: none;
      }

      .custom-row-border-bottom {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 30px;
      }
      .custom-border {
        border: 1px solid green;
        padding: 10px 5px;
        border-radius: 10px;
      }
      .row-padding {
        margin-bottom: 20px;
      }

      /* Hide fields by default */
      .hidden {
        display: none;
      }
      #return-response {
        margin: 20px;
        width: 100%;
      }

      /* Table styles */
      .table-container {
        overflow-y: auto;
        overflow-x: auto;
        position: relative;
      }

      table#taRecordTableContent {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        text-align: left;
      }

      #taRecordTableContent th,
      #taRecordTableContent td {
        padding: 10px 15px;
        /*border: 1px solid #b9bdb9;*/
        white-space: nowrap; /* Prevent line wrapping */
        text-align: center;
      }
      thead tr {
        vertical-align: middle;
      }

      /* Header styling */
      #taRecordTableContent thead th {
        background-color: #e6e4e4;
        color: #333;
        font-weight: bold;
        text-align: center;
      }

      /* Hover effects */
      #taRecordTableContent tbody tr:hover {
        background-color: #f1f1f1;
      }

      /* Center align specific columns */
      #taRecordTableContent td:nth-child(4),
      #taRecordTableContent td:nth-child(5),
      #taRecordTableContent td:nth-child(6),
      #taRecordTableContent td:nth-child(7),
      #taRecordTableContent td:nth-child(8),
      #taRecordTableContent td:nth-child(9),
      #taRecordTableContent td:nth-child(10),
      #taRecordTableContent td:nth-child(13),
      #taRecordTableContent td:nth-child(14),
      #taRecordTableContent td:nth-child(15),
      #taRecordTableContent td:nth-child(16),
      #taRecordTableContent td:nth-child(17),
      #taRecordTableContent td:nth-child(18),
      #taRecordTableContent td:nth-child(19) {
        text-align: center;
      }

      /* Checkbox column */
      #taRecordTableContent td:first-child {
        text-align: center;
        width: 50px;
      }

      #taRecordTableContent td:last-child {
        border: transparent;

        color: #000;
        background-color: #f3f5f7;
      }

      /* Table header alignment */
      #taRecordTableContent th {
        text-align: center;
      }

      /* Styling for no records row */
      #taRecordTableContent .text-center {
        text-align: center;
        font-weight: bold;
        color: #999;
      }
      thead {
        background-color: #f2f2f2; /* Background color for the header */
        position: sticky; /* Make header sticky */
        top: 0; /* Position it at the top */
        z-index: 10; /* Ensure header is above other content */
      }

      /* Fixed Serial Number Column */
      .fixed-sr {
        position: sticky;
        left: 0;
        background-color: #e6e4e4 !important;
        color: #000 !important;
        z-index: 2;
      }

      .pending-row td {
        color: #114f62;
        /*background-color: #b6cddb;*/
        /*border: #000;*/
      }

      .approved-row td {
        /*border: #000;*/
        /*background-color: #d4edda;  Green for Approved */
        color: #286840;
      }
      .reject-row td {
        color: #840404;
        /*background-color: #fbdddd;*/
      }
      .clickable-cell {
        cursor: pointer;
      }

      .excel-container {
        padding: auto;
      }

      .content {
        margin-left: 0;
        /*padding: 0 2rem;*/
        overflow: auto;
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      /********Footer Style ********/
      .footer {
        display: none;
      }

      a.tab {
        padding: 5px 0px;
        cursor: pointer;

        transition: background-color 0.3s ease;
      }

      a.tab img {
        margin: 0 10px;
      }
      a.tab-name {
        padding: 0 12px;
      }

      a.tab p {
        text-align: center;
        text-decoration: none;
        color: rgb(1, 111, 190);
        margin-bottom: 0;
      }

      p.user-designation {
        font-size: 14px;
      }
      .submit-btn {
        padding: 6px 16px; /* Increased padding for better click area */
        border: none;
        border-radius: 8px; /* Slightly larger border-radius for a smoother look */
        color: #fff; /* White text color */
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        /* margin-right: 10px;*/
        transition: background-color 0.3s ease, transform 0.2s ease; /* Added transform transition for button press effect */

        background-color: #2f84c1; /* Solid background color */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
      }

      .submit-btn:hover {
        background-color: #357abd; /* Darker shade on hover */
        transform: scale(1.05); /* Slightly enlarge the button on hover */
        color: #fff; /* White text color */
      }

      .submit-btn:focus {
        outline: none; /* Remove the default focus outline */
      }

      .submit-btn:active {
        background-color: #2a5d9e; /* Even darker shade when button is pressed */
        transform: scale(0.98); /* Slightly shrink the button when pressed */
      }

      /* Delete Button Gradient */
      /*.delete-btn {
                background: #ff0000;
              }

              .delete-btn:hover {
                background: #fb2c2c;
                color: #fff;
              }*/

      /* Select All Button Gradient */
      .select-all-btn {
        background: #007486;
      }

      .select-all-btn:hover {
        background: #35aaac;
        color: #fff;
      }

      /* CSS for the overlay */
      #please-wait-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .overlay-content {
        text-align: center;
        font-size: 18px;
        font-weight: bold;
      }

      .local-container {
        display: flex;
      }

      button.btn.reset-btn:active {
        outline: none;
        border: none;
      }

      /* Popup styles */
      .dynamic-popup {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(
          0,
          0,
          0,
          0.5
        ); /* Black background with opacity */
      }

      .dynamic-popup-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 800px;
        border-radius: 10px;
      }

      .dynamic-popup-close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .dynamic-popup-close-btn:hover,
      .dynamic-popup-close-btn:focus {
        color: black;
        text-decoration: none;
      }

      .dynamic-table {
        width: 100%;
        border-collapse: collapse;
      }

      .dynamic-table th,
      .dynamic-table td {
        border: 1px solid #ddd;
        padding: 8px;
      }

      .dynamic-table th {
        background-color: #f2f2f2;
      }

      /*.input-with-icon {
          position: relative;
        }*/

      /*.input-with-icon .form-control {
          padding-right: 2.5rem;
        }*/

      /*.input-with-icon .calendar-icon {
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 1.2em;
          color: #999;
          pointer-events: none;
        }*/

      .form-control,
      .form-select {
        color: #616c77;
      }
      .location-icon {
        margin-top: 5px;
        margin-right: 2px;
      }

      .sidebar {
        height: 100vh;
        background-color: #343a40;
        padding: 1rem;
        position: fixed;
        left: 0;
      }
      .sidebar a {
        color: #ffffff;
        text-decoration: none;
        display: block;
        padding: 12px;
        margin-bottom: 0.5rem;
        border-radius: 0.25rem;
        transition: background-color 0.2s;
      }
      a.tab:hover,
      a.tab.active {
        background-color: #495057;
        color: #ffffff;
      }

      /* home page CSS */

      button#create-ta {
        background: #357abd;
        font-weight: 700;
        font-size: 18px;
        padding: 10px 28px;
      }

      button#create-ta {
        background: #357abd;
        font-weight: 700;
        font-size: 18px;
        padding: 10px 28px;
      }

      a#create-ta:active {
        border: none;
      }

      .ta-request-container {
        display: flex;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      a.ta-Details {
        text-decoration: none;
      }

      .ta-Details {
        padding: 20px 40px;
        background-color: white;
        border-radius: 5px;
      }

      #pending {
        margin-right: 10px;
      }

      .label {
        font-weight: 700;
        margin-right: 8px;
        font-size: x-large;
      }

      .ta-Approval-Container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0px;
      }

      .count {
        margin-right: 5px;
      }

      .main-container {
        border-radius: 8px;
        padding: 0;
        margin-top: 10px;
      }
      th.fixed-tot,
      td.fixed-tot {
        position: sticky;
        background-color: #c3e6cb !important;
        color: #155724 !important;
        right: 0;
        z-index: 2;
      }

      .amount-summary {
        padding: 1rem;
        border: 1px solid #387e38;
        border-radius: 8px;
        background-color: #eaf5ee;
        color: #286840;
      }

      .summary-item {
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .amount-value {
        font-weight: bold;
        color: #286840;
        float: right;
      }
      .summary-heading {
        font-weight: bold;
      }

      .tracker {
        display: flex;
        align-items: center;
      }

      /*Approval tracker style*/

      .line {
        flex-grow: 1;
        height: 2px;
        background-color: gray;
        /*margin: 0 5px;*/
      }

      .stage img {
        width: 24px;
        height: 24px;
        display: block;
      }

      /* Sidebar visibility */
      .sidebar {
        transition: transform 0.3s ease; /* Smooth transition when showing/hiding */
        transform: translateX(0); /* Default position */
      }

      /* Hidden sidebar */
      .sidebar-hidden {
        transform: translateX(-100%);
      }

      /* Full-width content when sidebar is hidden */
      .full-width-content {
        transition: width 0.3s ease;
        width: 100% !important;
      }

      /* Position the toggle button so it's always visible */
      #toggleSidebar {
        transition: left 0.3s ease;
        padding: 0;
      }

      /* Move toggle button when sidebar is hidden */
      .sidebar-hidden + #toggleSidebar {
        left: 10px; /* Adjust this value based on how far you want it to move */
      }
      #content-column {
        transition: margin-left 0.3s ease; /* Smooth transition when sidebar shows/hides */
      }

      /* When the sidebar is hidden, fix the button in position */
      .fixed-btn {
        position: fixed;
        left: 10px; /* Adjust as needed */
        z-index: 1000; /* Ensure the button is always visible */
      }
      /*button#navbarToggler {
          vertical-align: text-top;
        }*/
      .ta-home-img {
        display: none;
      }
      #table-heading h5 {
        margin-bottom: 0;
      }
      .pagination-wrapper {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
      }

      /* Extra small devices (portrait phones, less than 576px) */
      @media (max-width: 768px) {
        .ta-home {
          display: none;
        }
        .ta-home-img {
          display: block;
        }
        .ta-nav {
          align-items: center;
          padding: 15px 18px;
        }

        a.ta-heading {
          font-size: 16px;
          text-align: center;
        }
        .user-details {
          text-align: left;
        }

        .user-icon img {
          width: 25px;
          height: 25px;
        }
        .user-icon {
          margin: 0;
        }
        .current-user {
          font-size: 10px;
        }
        p.user-designation {
          font-size: 8px;
        }
        #sidebar-column {
          display: none;
        }
        #table-heading h5 {
          margin-bottom: 0;
          font-size: 1rem;
        }

        table#taRecordTableContent {
          font-size: 12px;
        }
        /****save button *****/
        .add-button {
          padding: 6px 12px;
          font-size: medium;
        }
        .submit-btn {
          font-size: 14px;
        }
        /*****table style****/
        #taRecordTableContent th,
        #taRecordTableContent td {
          padding: 5px 10px;
        }

        /*****Footer style******/
        .footer {
          display: flex;
          background-color: #f8f9fa;
          position: fixed;
          width: 100%;
          z-index: 1000;
          bottom: 0;
        }
        .footer-menu {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .footer-menu a {
          text-align: center;
        }
        a.tab img {
          vertical-align: middle;
          margin-right: 0;
        }
        a.tab:hover,
        a.tab.active {
          color: rgb(0 128 222);
          font-weight: bold;
          border-bottom: 3px solid rgb(0 128 222);
          background: transparent;
        }

        h6.m-0 {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    {% if frappe.session.user != "Guest" %}
    <div class="container-fluid ta-container">
      <header class="navbar navbar-expand-lg ta-nav sticky-top">
        <!--<div>
          <button
            class="navbar-toggler hidden"
            type="button"
            id="navbarToggler"
          >
            <span class="navbar-toggler-icon">&#9776;</span>
          </button>
       
        </div>-->
        <a href="/app" class="ta-home-img">
          <span
            ><img
              src="/assets/travel_allowance/images/ta_home.png"
              alt="home"
              width="23" /></span
        ></a>
        <a href="/app" class="ta-home">&lt; Home</a>

        <a class="ta-heading">Travel Allowance</a>
        <a class="ta-heading" style="display: none">TA</a>
        <!-- Dropdown for user details and logout -->
        <div class="dropdown">
          <a
            class="user-details d-flex align-items-center dropdown-toggle"
            id="user-details"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <div class="user-info me-1">
              <h4
                class="current-user m-0"
                hx-get="/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_employee_name"
                hx-trigger="load"
                hx-target="this"
                hx-vals='js:{"email": "{{ frappe.session.user }}"}'
              ></h4>
              <p class="user-designation m-0" id="user-designation"></p>
            </div>
            <span class="user-icon">
              <img src="/files/user (5).png" alt="" width="40" />
            </span>
          </a>

          <!-- Dropdown Menu -->
          <ul
            class="dropdown-menu dropdown-menu-end"
            aria-labelledby="user-details"
          >
            <li><a class="dropdown-item logout-btn">Logout</a></li>
          </ul>
        </div>
      </header>

      <div class="container-fluid" id="main-content">
        <div class="row">
          <div class="col-md-2" id="sidebar-column">
            <div class="sidebar" id="sidebar">
              <!-- Sidebar content -->
              <!-- Button to trigger modal -->
              <button
                class="btn create-ta text-white my-4"
                id="create-ta"
                data-bs-toggle="modal"
                data-bs-target="#travelFormModal"
                onclick="checkTACategory()"
              >
                New Request +
              </button>

              <!-- Tabs -->
              <a
                href="#my-travel"
                class="nav-link tab active"
                id="my-travel-tab"
                onclick="navigateTo('my-travel')"
              >
                <img src="/files/profile (2).png" width="25" alt="My Travel" />
                <span class="tab-name">My Travel</span>
              </a>

              <a
                href="#rp-approval"
                class="nav-link tab"
                id="rp-approval-tab"
                onclick="navigateTo('rp-approval')"
              >
                <img
                  src="/files/notification.png"
                  width="25"
                  alt="Requests"
                  title="Reporting Person Approval"
                />
                RP Approval <span class="" id="requestCount"></span>
              </a>

              <a
                href="#skip-approval"
                class="nav-link tab"
                id="skip-approval-tab"
                onclick="navigateTo('skip-approval')"
              >
                <img
                  src="/files/notification.png"
                  width="25"
                  alt="skipRequest"
                />
                Skip Approval <span class="" id="requestCount"></span>
              </a>

              <a
                href="#finance-approval"
                class="nav-link tab"
                id="finance-approval-tab"
                onclick="navigateTo('finance-approval')"
              >
                <img
                  src="/files/notification.png"
                  width="25"
                  alt="Finance Approval"
                />
                Finance Approval
              </a>

              <a
                href="#TAPolicy"
                class="nav-link tab"
                id="ta-policy-tab"
                onclick="navigateTo('TAPolicy')"
              >
                <img src="/files/test.png" width="25" alt="TA Policy" />
                TA Policy
              </a>
            </div>
          </div>

          <div class="col-md-10" id="content-column">
            <!-- Button to toggle sidebar -->

            <div id="my-travel-section" class="my-3 px-3">
              <div class="col-12 d-flex align-items-center">
                <div id="table-heading">
                  <h5>Travel Claim History</h5>
                  <!-- <span id="current-month"></span>-->
                </div>
                <a
                  class="create-btn ms-2"
                  id="create-ta"
                  data-bs-toggle="modal"
                  data-bs-target="#travelFormModal"
                  onclick="checkTACategory()"
                  style="cursor: pointer; display: none"
                >
                  <img
                    src="/assets/travel_allowance/images/create.png"
                    alt="New Request"
                    width="25"
                  />
                </a>
                <div class="ms-auto">
                  <!--TA Record submit button-->
                  <button class="btn submit-btn" id="ta-submit-btn">
                    Submit
                  </button>
                </div>
              </div>

              <!--For My travel table container-->
              <div class="container-fluid main-container">
                <div class="table-container" id="taRecordTable">
                  <table id="taRecordTableContent" class="table">
                    <thead>
                      <tr>
                        <th class="d-none">Name</th>
                        <th class="fixed-sr">#</th>
                        <th>Status</th>
                        <!-- Main header for Approval Tracker with 3 sub-columns -->
                        <th>
                          Approval Tracker
                          <div
                            style="
                              display: flex;
                              justify-content: space-between;
                              width: 100%;
                              border-top: 1px solid;
                            "
                          >
                            <span>RP</span>
                            <span>Skip</span>
                            <span>TA</span>
                          </div>
                        </th>

                        <th>Action</th>
                        <th>From</th>
                        <th>Date From</th>
                        <th>Time From</th>
                        <th>To</th>
                        <th>Date To</th>
                        <th>Time To</th>
                        <th>Total Time (in hours)</th>
                        <th>Purpose</th>
                        <th>Travel Mode</th>
                        <th>Total km</th>
                        <th>Ticket Amt</th>
                        <th>Fare Amount</th>
                        <!--<th>Allowance Type</th>-->
                        <th>DA</th>
                        <th>Halting</th>
                        <th>Lodging</th>
                        <th>Local Conveyance</th>
                        <th>View Ticket Attachment</th>
                        <th>View Lodging Attachment</th>
                        <th class="fixed-tot">Total</th>
                        <th>Modified</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <!-- Pagination Controls with Page Numbers -->
              <div class="container-fluid hidden">
                <div class="row pt-1">
                  <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                      <li class="page-item">
                        <a class="page-link" href="#" aria-label="Previous">
                          <span aria-hidden="true">&laquo;</span>
                        </a>
                      </li>
                      <li class="page-item">
                        <a class="page-link" href="#">1</a>
                      </li>
                      <li class="page-item">
                        <a class="page-link" href="#">2</a>
                      </li>
                      <li class="page-item">
                        <a class="page-link" href="#">3</a>
                      </li>
                      <li class="page-item">
                        <a class="page-link" href="#" aria-label="Next">
                          <span aria-hidden="true">&raquo;</span>
                        </a>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>

              <!--Handsonable Table for TA Records-->
              <!--<div id="excel-canvas" class="excel-container"></div>-->

              <!--Show Message For No records created yet-->
              <div id="no-records-message" style="display: none">
                You don't have any records yet. Click
                <!-- Button to trigger modal -->
                <a
                  class="btn create-ta"
                  id="create-ta"
                  onclick="checkTACategory()"
                  style="
                    font-weight: 700;
                    font-size: 18px;
                    border: none;
                    cursor: pointer;
                    text-decoration: underline;
                  "
                  data-bs-toggle="modal"
                  data-bs-target="#travelFormModal"
                >
                  here
                </a>
                to add your first record or you can click on Create+ button.
              </div>
            </div>
            <div id="rp-approval-section" class="px-3" style="display: none">
              <div class="container-fluid">
                {% include 'templates/includes/ta-rp-approval.html' %}
              </div>
            </div>

            <div id="skip-approval-section" class="px-3" style="display: none">
              <div class="container-fluid">
                {% include 'templates/includes/skip-approval.html' %}
              </div>
            </div>

            <div
              id="finance-approval-section"
              class="px-3"
              style="display: none"
            >
              <div class="container-fluid">
                {% include 'templates/includes/ta-finance-approval.html' %}
              </div>
            </div>

            <div id="ta-policy-section" class="px-3" style="display: none">
              <div class="container-fluid">
                <div id="pdf-container"></div>
                <!-- Container for multiple pages -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--Travel Allowance Form as Modal/Popup-->
      <!--<h2>Travel Allowance Form</h2>-->
      <div
        class="modal fade"
        id="travelFormModal"
        tabindex="-1"
        aria-labelledby="travelFormModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 id="modalTitle" class="modal-title" id="travelFormModalLabel">
                Travel Allowance Form
              </h5>
              <!--<button type="button" class="btn reset-btn" aria-label="Reset" data-bs-toggle="tooltip"  title="Reset" onclick="resetForm()">
                  <img src="/files/icons8-reset-48.png" alt="" width="20">
                </button>-->

              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form id="travel-form" onsubmit="handleFormSubmit(event)">
                <div class="container-fluid">
                  <div class="row row-padding">
                    <h6>Source Details</h6>
                    <div class="col-md-3 d-flex">
                      <span class="location-icon">
                        <img
                          src="/files/icons8-location-40.png"
                          alt="Icon"
                          width="20"
                          class="icon-img"
                        />
                      </span>
                      <select
                        class="form-select"
                        id="from_location"
                        name="from_location"
                        required
                        onchange="calculateDistance()"
                      >
                        <option value="">Select a city...</option>
                      </select>
                    </div>
                    <div class="col-md-3 hidden" id="from_location_other_group">
                      <input
                        class="form-control"
                        type="text"
                        id="from_location_other"
                        name="from_location_other"
                        placeholder="Other Location"
                        oninput="calculateDistance()"
                      />
                      <!--<span class="description">Enter location for 'Other'.</span>-->
                    </div>

                    <div class="col-md-3">
                      <div class="input-with-icon">
                        <input
                          class="form-control"
                          type="date"
                          id="from_date"
                          name="from_date"
                          placeholder="Start Date"
                          required
                        />
                        <!-- <i class="fa-regular fa-calendar-days calendar-icon"></i>-->
                      </div>
                    </div>

                    <div class="col-md-3">
                      <input
                        class="form-control"
                        type="time"
                        id="from_time"
                        name="from_time"
                        placeholder="Start Time"
                        required
                      />
                    </div>
                  </div>
                  <div class="row row-padding custom-row-border-bottom">
                    <h6>Destination Details</h6>
                    <div class="col-md-3 d-flex">
                      <span class="location-icon">
                        <img
                          src="/files/icons8-location-40 (1).png"
                          alt="Icon"
                          width="23"
                          height="25"
                          class="icon-img"
                        />
                      </span>
                      <select
                        class="form-select"
                        id="to_location"
                        name="to_location"
                        required
                        hx-get="/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_allowances"
                        hx-trigger="change"
                        hx-target="#return-response"
                        hx-include="[name='allowance_type']"
                        onchange="calculateDistance()"
                      >
                        <option value="">Select a city...</option>
                      </select>
                    </div>
                    <div class="col-md-3 hidden" id="to_location_other_group">
                      <input
                        class="form-control"
                        type="text"
                        id="to_location_other"
                        name="to_location_other"
                        placeholder="Other Location"
                        oninput="calculateDistance()"
                      />

                      <!--<span class="description">Enter location for 'Other'.</span>-->
                    </div>
                    <div class="col-md-3">
                      <div class="input-with-icon">
                        <input
                          class="form-control"
                          type="date"
                          id="to_date"
                          name="to_date"
                          placeholder="End Date"
                          required
                        />
                        <!-- <i class="fa-regular fa-calendar-days calendar-icon"></i>-->
                      </div>
                    </div>
                    <div class="col-md-3">
                      <input
                        class="form-control"
                        type="time"
                        id="to_time"
                        name="to_time"
                        placeholder="End Time"
                        required
                      />
                    </div>
                  </div>

                  <div class="row row-padding custom-row-border-bottom">
                    <div class="col-md-6">
                      <label for="total_time">Total Time (in hours)</label>
                      <input
                        class="form-control"
                        class="total_time"
                        id="total_time"
                        readonly
                      />
                    </div>

                    <div class="col-md-6">
                      <label for="purpose">Purpose of Travel</label>
                      <input
                        class="form-control"
                        id="purpose"
                        name="purpose"
                        required
                      />
                    </div>
                  </div>
                  <!--Travel Mode details-->
                  <div class="row row-padding custom-row-border-bottom">
                    <h6 class="pb-3">Travel Mode Details</h6>

                    <div class="col-md-3">
                      <p id="distanceResult"></p>
                      <select
                        class="form-select form-control"
                        id="travel_mode"
                        name="travel_mode"
                        required
                      >
                        <option value="">Select Travel mode</option>
                        <option value="Bike">Bike</option>
                        <option value="Train">Train</option>
                        <option value="Bus">Bus</option>
                        <option value="Car">Car</option>
                        <option value="Cab">Cab</option>
                      </select>
                    </div>

                    <!-- Total km field (hidden by default) -->
                    <div class="col-md-3 hidden" id="total_km_group">
                      <input
                        class="form-control"
                        type="number"
                        id="total_km"
                        name="total_km"
                      />
                      <small
                        class="form-text text-muted"
                        style="margin-left: 5px"
                      >
                        Enter Total Kilometer
                      </small>
                    </div>
                    <!-- Ticket Amount field (hidden by default) -->
                    <div class="col-md-3 hidden" id="ticket_amount_group">
                      <input
                        class="form-control"
                        type="number"
                        id="ticket_amount"
                        name="ticket_amount"
                      />
                      <small
                        class="form-text text-muted"
                        style="margin-left: 5px"
                      >
                        Enter Ticket Amount
                      </small>
                    </div>
                    <div class="col-md-3 hidden" id="upload_ticket_group">
                      <!--<label for="attachment">Upload Ticket </label>-->
                      <input
                        class="form-control"
                        type="file"
                        id="upload_ticket"
                        name="upload_ticket"
                        accept=".pdf,.jpg,.jpeg,.png"
                      />
                      <small
                        class="form-text text-muted"
                        style="margin-left: 5px"
                      >
                        Upload Ticket
                      </small>
                    </div>
                  </div>

                  <div class="row row-padding custom-row-border-bottom">
                    <h6 class="pb-3">Allowances Details:</h6>
                    <div class="col-md-3">
                      <select
                        class="form-select"
                        id="allowance_type"
                        name="allowance_type"
                        required
                      >
                        <option value="">Select Allowances</option>
                        <option value="DA">DA</option>
                        <option value="Halting">Halting</option>
                        <option value="Lodging">Lodging</option>
                        <option value="DA and Lodging">DA and Lodging</option>
                      </select>
                    </div>

                    <!-- Lodging Amount field (hidden by default) -->
                    <div class="col-md-3 hidden" id="lodging_amount_group">
                      <input
                        class="form-control"
                        type="number"
                        id="lodging_amount"
                        name="lodging_amount"
                      />
                      <small
                        class="form-text text-muted"
                        style="margin-left: 5px"
                      >
                        Enter Lodging Amount
                      </small>
                    </div>
                    <!-- Total Days Stay in Lodge field (hidden by default) -->
                    <div class="col-md-3 hidden" id="day_stay_lodge_group">
                      <input
                        class="form-control"
                        type="number"
                        id="day_stay_lodge"
                        name="day_stay_lodge"
                      />
                      <small
                        class="form-text text-muted"
                        style="margin-left: 5px"
                      >
                        Enter Total Days Stay in Lodge (e.g., 1, 2, 3...).
                      </small>
                    </div>
                    <div class="col-md-3 hidden" id="upload_lodging_group">
                      <input
                        class="form-control"
                        type="file"
                        id="upload_lodging"
                        name="upload_lodging"
                        accept=".pdf,.jpg,.jpeg,.png"
                      />
                      <small
                        class="form-text text-muted"
                        style="margin-left: 5px"
                      >
                        Upload Lodging Bill
                      </small>
                    </div>
                  </div>

                  <div class="row row-padding">
                    <div class="col">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="local_conveyance"
                          name="local_conveyance"
                          data-bs-toggle="tooltip"
                          data-bs-placement="right"
                        />
                        <label class="form-check-label" for="local_conveyance">
                          Local Conveyance
                        </label>
                        <br />
                        <small class="form-text text-muted">
                          Check this box if you have local travel expenses
                          during your trip (e.g., taxi, auto).
                        </small>
                      </div>
                    </div>
                  </div>

                  <div class="row row-padding">
                    <!-- Local Conveyance Form Container (initially hidden) -->
                    <div id="local-container" class="hidden" inert>
                      <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                          <thead class="table-light">
                            <tr>
                              <th style="width: 10%">Date</th>
                              <th style="width: 15%">From</th>
                              <th style="width: 15%">To</th>
                              <th style="width: 20%">Purpose</th>
                              <th style="width: 20%">Travel Mode</th>
                              <th style="width: 10%">Amount</th>
                              <th style="width: 10%">Action</th>
                            </tr>
                          </thead>
                          <tbody id="local-conveyance-body">
                            <!-- Rows will be added here dynamically -->
                          </tbody>
                        </table>
                      </div>
                      <button
                        type="button"
                        id="add_row_btn"
                        class="btn btn-primary"
                        aria-label="Add a new row to the table"
                      >
                        Add Row
                      </button>
                    </div>
                  </div>

                  <div class="row row-padding custom-border hidden">
                    <div class="col-md-3 hidden" id="fare_amount_group">
                      <label for="fare_amount">Fare Amount</label>
                      <input
                        class="form-control"
                        type="number"
                        id="fare_amount"
                        name="fare_amount"
                        readonly
                      />
                    </div>
                    <!-- Add a placeholder to show the final DA amount -->
                    <div class="col-md-3 hidden" id="da_amount_group">
                      <label for="final_da_amount">DA Amount</label>
                      <input
                        class="form-control"
                        id="final_da_amount"
                        name="final_da_amount"
                        readonly
                      />
                    </div>
                    <!-- Final Lodging Amount field (hidden by default) -->
                    <div class="col-md-3 hidden" id="final_lodge_amount_group">
                      <label for="final_lodge_amount"
                        >Total Lodging Amount</label
                      >
                      <input
                        class="form-control"
                        type="number"
                        id="final_lodge_amount"
                        name="final_lodge_amount"
                        readonly
                      />
                    </div>
                    <!-- Final Halting Amount field (hidden by default) -->
                    <div class="col-md-3 hidden" id="final_halt_amount_group">
                      <label for="final_halt_amount">Halting Amount</label>
                      <input
                        class="form-control"
                        type="number"
                        id="final_halt_amount"
                        name="final_halt_amount"
                        readonly
                      />
                    </div>
                    <div class="col-md-3 hidden" id="final_local_amount_group">
                      <label for="local_amount">Local Conveyance Amount</label>
                      <input
                        class="form-control"
                        type="number"
                        id="final_local_amount"
                        name="final_local_amount"
                        readonly
                      />
                    </div>

                    <div class="col-md-3 hidden" id="tatal_amount_group">
                      <label for="total_amount">Total Amount</label>
                      <input
                        class="form-control"
                        type=""
                        id="total_amount"
                        name="total_amount"
                        readonly
                      />
                    </div>
                  </div>
                  <!--For client side to show amount summary to user-->
                  <div class="amount-summary hidden" id="amount-summary">
                    <h6 class="summary-heading">Allowances Summary:</h6>
                    <p id="fare_amount_summary" class="summary-item hidden">
                      Fare Amount: <span class="amount-value"></span>
                    </p>
                    <p id="da_amount_summary" class="summary-item hidden">
                      DA Amount: <span class="amount-value"></span>
                    </p>
                    <p
                      id="final_lodge_amount_summary"
                      class="summary-item hidden"
                    >
                      Lodging Amount: <span class="amount-value"></span>
                    </p>
                    <p
                      id="final_halt_amount_summary"
                      class="summary-item hidden"
                    >
                      Halting Amount: <span class="amount-value"></span>
                    </p>
                    <p
                      id="final_local_amount_summary"
                      class="summary-item hidden"
                    >
                      Local Conveyance Amount:
                      <span class="amount-value"></span>
                    </p>
                    <hr />
                    <p id="total_amount_summary" class="summary-item hidden">
                      Total Amount: <span class="amount-value"></span>
                    </p>
                  </div>
                </div>
                <div class="row">
                  <div class="col text-center">
                    <button type="submit" class="add-button" id="add-button">
                      Save
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!--For user info only-->
      <p id="total_duration" class="hidden"></p>
      <p id="fare" class="hidden"></p>
      <p id="da"></p>
      <p id="halt"></p>
      <p id="lodge"></p>

      <!-- Display Total Amount -->
      <div id="total-amount" class="hidden">Total Amount: 0</div>

      <!--for calculations hidden for end user (Important for backend calculation)-->
      <p id="da-amount" class="hidden"></p>
      <p id="lodging-amount" class="hidden"></p>
      <p id="halting-amount" class="hidden"></p>
      <div id="return-response" class="hidden"></div>

      <!-- Response Container for Feedback -->
      <div id="response-container"></div>

      <!-- Overlay HTML -->
      <div id="please-wait-overlay" style="display: none">
        <div class="overlay-content">
          <p>Please wait...</p>
        </div>
      </div>

      <!-- Popup HTML to show local conveyance child table -->
      <div id="local-conveyance-popup" class="dynamic-popup">
        <div class="dynamic-popup-content">
          <span class="dynamic-popup-close-btn">&times;</span>
          <h4>Local Conveyance Details</h4>
          <div id="local-conveyance-container"></div>
        </div>
      </div>
    </div>

    <!-- Footer container -->
    <footer class="footer mt-auto py-3 bg-light">
      <div class="container">
        <div class="row">
          <!-- Footer content -->

          <div class="footer-menu">
            <!-- Button to trigger modal 
            <a
              class="btn"
              id="create-ta"
              data-bs-toggle="modal"
              data-bs-target="#travelFormModal"
              onclick="checkTACategory()"
            >
              <img
                src="/assets/travel_allowance/images/create.png"
                alt="New Request"
                width="25"
              />
              <h6 class="m-0">Create</h6>
            </a>-->

            <a href="#" class="nav-link tab active" id="my-travel">
              <img src="/files/profile (2).png" width="25" alt="My Travel" />
              <h6 class="m-0">My Travel</h6>
            </a>

            <a href="#" class="nav-link tab" id="requests">
              <img
                src="/files/notification.png"
                width="25"
                alt="Requests"
                title="Reporting Person Approval"
              />
              <h6 class="m-0">RP Approval</h6>
              <span class="" id="requestCount"></span>
            </a>

            <a href="#" class="nav-link tab" id="skipRequest">
              <img
                src="/files/notification.png"
                width="25"
                alt="Skip Approval"
              />
              <h6 class="m-0">Skip Approval</h6>
              <span class="" id="requestCount"></span>
            </a>

            <a href="#" class="nav-link tab" id="taPolicy">
              <img src="/files/test.png" width="25" alt="TA Policy" />
              <h6 class="m-0">TA Policy</h6>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap Modal for dialog to show ta record-->
    <!-- Bootstrap Modal -->
    <div
      class="modal fade"
      id="dataDialog"
      tabindex="-1"
      role="dialog"
      aria-labelledby="modalTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Record Details</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
              onclick="closeDialog()"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="dialogContent">
            <!-- Dynamic content will be inserted here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
              onclick="closeDialog()"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    {% else %} {% include "/templates/includes/not-found.html" %} {% endif %}

    <!--to include the PDF.js library from a CDN-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS and Popper.js (necessary for dropdowns) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script>
      //Hide or unhide side bar functionality
      /*document
            .getElementById("navbarToggler")
            .addEventListener("click", function () {
              var sidebar = document.getElementById("sidebar");
              var sidebarColumn = document.getElementById("sidebar-column");
              var toggleSidebarBtn = document.getElementById("toggleSidebar");
              var contentColumn = document.getElementById("content-column");

              // Toggle sidebar visibility
              sidebarColumn.classList.toggle("sidebar-hidden");

              // Adjust content column to full width when sidebar is hidden
              contentColumn.classList.toggle("full-width-content");

              // Check if the sidebar is hidden
              if (sidebarColumn.classList.contains("d-none")) {
                // Move the toggle button to a fixed position
                toggleSidebarBtn.classList.add("fixed-btn");
                toggleSidebarBtn.innerHTML = `<img src="/assets/travel_allowance/images/sidebar.png" alt="Open Sidebar" width="30" />`;
              } else {
                // Move the toggle button back inside the sidebar
                toggleSidebarBtn.classList.remove("fixed-btn");
                toggleSidebarBtn.innerHTML = `<img src="/assets/travel_allowance/images/sidebar.png" alt="Close Sidebar" width="30" />`;
              }
            });*/

      async function fetchEmployeeDesignation() {
        try {
          const response = await fetch(
            `/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_employee_designation`
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json(); // Parse the JSON response
          const empDesignation = data.message.designation;
          if (empDesignation != "Not available") {
            document.getElementById("user-designation").textContent =
              empDesignation;
          } else {
            document.getElementById("user-designation").textContent = "";
          }

          manageTravelModeOptions(empDesignation);
          console.log("Employee Designation:", empDesignation); // Log the response to the console
        } catch (error) {
          console.error("Error fetching employee designation:", error);
          document.getElementById("user-designation").textContent = "";
        }
      }

      // Call the async function
      fetchEmployeeDesignation();

      function manageTravelModeOptions(empDesignation) {
        // List of designations that should have the "Air" option
        const airTravelDesignations = [
          "CEO",
          "CHRO",
          "Chief Technology Officer",
          "CFO",
          "Chief Operating Officer",
          "General Manager",
          "Chief Loan Officer",
        ];

        // Get the travel mode dropdown element
        const travelModeSelect = document.getElementById("travel_mode");

        // Check if the employee's designation matches any of the allowed ones
        if (airTravelDesignations.includes(empDesignation)) {
          // Check if "Air" is already present to avoid duplicates
          let airOptionExists = false;
          for (let i = 0; i < travelModeSelect.options.length; i++) {
            if (travelModeSelect.options[i].value === "Air") {
              airOptionExists = true;
              break;
            }
          }

          // If "Air" is not already in the dropdown, add it
          if (!airOptionExists) {
            const airOption = document.createElement("option");
            airOption.value = "Air";
            airOption.text = "Air";
            travelModeSelect.add(airOption);
          }
        }
      }

      // funtion to get the count as notification in the Request tab of sidebar tab
      function fetchPendingCount() {
        const requestCount = document.getElementById("requestCount");
        fetch(
          "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_pending_count"
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json(); // Parse the JSON response
          })
          .then((data) => {
            console.log("data", data);
            // Extract the count from the message array
            const count = data.message[0]; // Access the first element of the message array
            if (count > 0) {
              // Update the count in the HTML
              requestCount.innerText = count;
              requestCount.classList.add("count"); // Add a class for styling if needed
            } else {
              requestCount.innerText = ""; // Clear count if no pending requests
              requestCount.classList.remove("count"); // Remove the class if count is zero
            }
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
      }

      // Fetch pending count immediately on page load
      fetchPendingCount();

      // Set interval to fetch the pending count every 5 minutes (300000 milliseconds)
      setInterval(fetchPendingCount, 120000);

      //Check TA category is set or not...onload event
      checkTACategory();

      async function checkTACategory() {
        try {
          // Perform the fetch request to call the server method
          const response = await fetch(
            `/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.check_ta_category`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();
          console.log("TA category response:", data.message);

          if (data) {
            if (data.message.error) {
              // Display SweetAlert message for errors
              Swal.fire({
                icon: "warning",
                title: "TA Category Issue",
                text: data.message.error,
                confirmButtonText: "OK",
              }).then(() => {
                document.getElementById("travelFormModal").style.display =
                  "none";

                // Use jQuery to hide the backdrop
                $(".modal-backdrop").remove(); // Remove the backdrop
              });
            } else {
              // Optionally handle successful response here
              console.log("TA Category check:", data.message.success);
              console.log("TA Category:", data.message.ta_category);
              // Show the modal only if TA Category check is successful
            }
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "No response received from the server.",
              confirmButtonText: "OK",
            });
          }
        } catch (error) {
          console.error("Fetch error:", error);
          Swal.fire({
            icon: "error",
            title: "Fetch Error",
            text: "There was an error contacting the server.",
            confirmButtonText: "OK",
          });
        }
      }

      fetchUserRoles();
      // Function to fetch user roles from the server
      async function fetchUserRoles() {
        try {
          const response = await fetch(
            `/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_user_roles`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error("Network response was not ok");
          }

          const data = await response.json();
          console.log("user data", data);
          const userRole = data.message.user_type;
          // Handle the data as needed
          console.log("User role", userRole); // You can use this data to control visibility of tabs
          manageTabVisibility(userRole);
        } catch (error) {
          console.error("Error fetching user roles:", error);
        }
      }

      // Function to manage role-based tab visibility
      function manageTabVisibility(userRoles) {
        // Define tab IDs and their corresponding roles
        const tabsConfig = {
          "Reporting Person": ["rp-approval"], // Show specific tabs for Reporting Person
          "Higher Reporting Person": ["skip-approval"], // Show specific tabs for Higher Reporting Person
          "Finance User": ["rp-approval", "finance-approval"], // Show specific tabs for Finance User
          employee: ["my-travel"], // Show specific tabs for Employees
        };

        // Hide all specific tabs initially
        const allTabs = ["rp-approval", "skip-approval", "finance-approval"];
        allTabs.forEach((tabId) => {
          const tabElement = document.getElementById(`${tabId}-tab`);
          if (tabElement) {
            tabElement.style.display = "none"; // Hide the tab element
          }
        });

        // Always show the My Travel tab
        const myTravelTab = document.getElementById("my-travel-tab");
        if (myTravelTab) {
          myTravelTab.style.display = "block"; // Show the My Travel tab
        }

        // Always show the TA Policy tab
        const taPolicyTab = document.getElementById("ta-policy-tab");
        if (taPolicyTab) {
          taPolicyTab.style.display = "block"; // Show the TA Policy tab
        }

        // Show tabs based on the user roles
        userRoles.forEach((role) => {
          const tabsToShow = tabsConfig[role] || [];
          tabsToShow.forEach((tabId) => {
            const tabElement = document.getElementById(`${tabId}-tab`);
            if (tabElement) {
              tabElement.style.display = "block"; // Show the tab element
            }
          });
        });
      }

      const url = "/files/SAHAYOG TRAVEL POLICY.pdf"; // Path to your PDF

      // PDF.js initialization
      const pdfjsLib = window["pdfjs-dist/build/pdf"];
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";

      // Asynchronous download of the PDF
      pdfjsLib.getDocument(url).promise.then((pdfDoc) => {
        const container = document.getElementById("pdf-container");
        const scale = 1.5; // Adjust scale as needed

        // Function to render a single page
        const renderPage = (pageNum) => {
          pdfDoc.getPage(pageNum).then((page) => {
            const viewport = page.getViewport({ scale: scale });

            // Create a canvas for each page
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            container.appendChild(canvas);

            // Disable right-click on the canvas
            canvas.addEventListener("contextmenu", (e) => {
              e.preventDefault();
            });

            // Render PDF page into the canvas context
            const renderContext = {
              canvasContext: context,
              viewport: viewport,
            };
            page.render(renderContext);
          });
        };

        // Loop through all pages and render them
        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
          renderPage(pageNum);
        }
      });

      //function to logout session
      document
        .querySelector(".logout-btn")
        .addEventListener("click", function (e) {
          e.preventDefault();

          fetch("/api/method/logout", {
            method: "GET",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (response.ok) {
                console.log("Logged out successfully");
                // Redirect to the #login section
                window.location.replace("/login"); // Use replace to prevent going back to the previous page
              } else {
                console.error("Failed to log out");
              }
            })
            .catch((error) => {
              console.error("Error during logout:", error);
            });
        });

      // Function to toggle sections visibility (shows one, hides others)
      function toggleSections(showSectionId, hideSectionIds, activeTabId) {
        const showSection = document.getElementById(showSectionId);

        // Hide all sections in the hideSectionIds array
        hideSectionIds.forEach((hideSectionId) => {
          const hideSection = document.getElementById(hideSectionId);
          if (hideSection) hideSection.style.display = "none";
        });

        // Show the requested section
        if (showSection) showSection.style.display = "block";

        setActiveTab(activeTabId);
      }

      // Function to remove "active" class from all tabs and add it to the clicked tab
      function setActiveTab(activeTabId) {
        // Get all sidebar links
        const tabs = document.querySelectorAll(".nav-link.tab");

        // Remove "active" class from all tabs
        tabs.forEach(function (tab) {
          tab.classList.remove("active");
        });

        // Add "active" class to the clicked tab
        const activeTab = document.getElementById(activeTabId);
        if (activeTab) {
          activeTab.classList.add("active");
        }
      }

      function navigateTo(section) {
        // Change the URL hash
        window.location.hash = section;

        // Toggle sections based on the active tab
        switch (section) {
          case "my-travel":
            toggleSections(
              "my-travel-section",
              [
                "rp-approval-section",
                "skip-approval-section",
                "finance-approval-section",
                "ta-policy-section",
              ],
              "my-travel-tab"
            );
            break;
          case "rp-approval":
            toggleSections(
              "rp-approval-section",
              [
                "my-travel-section",
                "skip-approval-section",
                "finance-approval-section",
                "ta-policy-section",
              ],
              "rp-approval-tab"
            );
            break;
          case "skip-approval":
            toggleSections(
              "skip-approval-section",
              [
                "my-travel-section",
                "rp-approval-section",
                "finance-approval-section",
                "ta-policy-section",
              ],
              "skip-approval-tab"
            );
            break;
          case "finance-approval":
            toggleSections(
              "finance-approval-section",
              [
                "my-travel-section",
                "rp-approval-section",
                "skip-approval-section",
                "ta-policy-section",
              ],
              "finance-approval-tab"
            );
            break;
          case "TAPolicy":
            toggleSections(
              "ta-policy-section",
              [
                "my-travel-section",
                "rp-approval-section",
                "skip-approval-section",
                "finance-approval-section",
              ],
              "ta-policy-tab"
            );
            break;
          default:
            break;
        }
      }
      // Call navigateTo based on the URL hash on page load
      window.onload = function () {
        const hash = window.location.hash.substring(1); // Get the hash without the #
        if (hash) {
          navigateTo(hash);
        } else {
          navigateTo("my-travel"); // Default section if no hash
        }
      };

      var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      /* for Local conveyance functionality of hide or unhide on check*/
      document.addEventListener("DOMContentLoaded", function () {
        const checkbox = document.getElementById("local_conveyance");
        const container = document.getElementById("local-container");
        const tbody = document.getElementById("local-conveyance-body");
        const addRowButton = document.getElementById("add_row_btn");

        // Replace these with the actual IDs or selectors for your from_date and to_date inputs
        const fromDateInput = document.getElementById("from_date");
        const toDateInput = document.getElementById("to_date");

        function createRow() {
          const row = document.createElement("tr");
          row.innerHTML = `
                              <td><input type="date" name="local_date[]" class="form-control form-control-sm local-date" required></td>
                              <td><input type="text" name="from_local[]" class="form-control form-control-sm" required></td>
                              <td><input type="text" name="to_local[]" class="form-control form-control-sm" required></td>
                              <td><input type="text" name="purpose[]" class="form-control form-control-sm" required></td>
                              <td>
                                  <select name="local_travel_mode[]" class="form-select form-select-sm" required>
                                      <option value="">Select</option>
                                      <option value="Auto">Auto</option>
                                      <option value="Cab">Cab</option>
                                      <option value="Public Transport">Public Transport</option>
                                  </select>
                              </td>
                              <td><input type="number" name="local_amt[]" class="form-control form-control-sm local-amt" required></td>
                              <td><button type="button" class="btn btn-danger btn-sm remove-row-button">Remove</button></td>
                          `;
          return row;
        }

        function addRow() {
          tbody.appendChild(createRow());
          addLocalConveyanceEventListeners();
        }

        function clearLocalConveyanceRows() {
          // Remove all rows
          while (tbody.children.length > 0) {
            tbody.removeChild(tbody.lastChild);
          }
          // Optionally add a new empty row for next use
          tbody.appendChild(createRow());
          calculateTotalLocalAmount(); // Reset total amount
        }

        function calculateTotalLocalAmount() {
          const localAmtInputs = document.querySelectorAll(".local-amt");
          let totalLocalAmount = 0;

          localAmtInputs.forEach((input) => {
            const amount = parseFloat(input.value) || 0;
            totalLocalAmount += amount;
          });

          // Update the final local amount input field
          document
            .getElementById("final_local_amount_group")
            .classList.remove("hidden");
          document.getElementById("final_local_amount").value =
            totalLocalAmount;

          document
            .getElementById("final_local_amount_summary")
            .classList.remove("hidden");
          document.querySelector(
            `#final_local_amount_summary .amount-value`
          ).textContent = "" + totalLocalAmount.toFixed(2);

          calculateTotalAmount();
        }

        function validateDate(date) {
          const fromDate = new Date(fromDateInput.value);
          const toDate = new Date(toDateInput.value);
          const inputDate = new Date(date);
          return inputDate >= fromDate && inputDate <= toDate;
        }

        function toggleRequiredAttributes(isRequired) {
          const localInputs = document.querySelectorAll(
            "#local-conveyance-body input, #local-conveyance-body select"
          );
          localInputs.forEach((input) => {
            if (isRequired) {
              input.setAttribute("required", "required");
            } else {
              input.removeAttribute("required");
            }
          });
        }

        function addLocalConveyanceEventListeners() {
          const localAmtInputs = document.querySelectorAll(".local-amt");
          localAmtInputs.forEach((input) => {
            input.addEventListener("input", calculateTotalLocalAmount);
          });

          const localDateInputs = document.querySelectorAll(".local-date");
          localDateInputs.forEach((input) => {
            input.addEventListener("change", function () {
              if (!validateDate(this.value)) {
                alert('Date must be between the "From Date" and "To Date".');
                this.value = ""; // Clear the invalid date
              }
            });
          });
        }

        checkbox.addEventListener("change", function () {
          if (this.checked) {
            container.classList.remove("hidden");
            container.removeAttribute("inert");
            if (tbody.children.length === 0) {
              addRow();
            }
            toggleRequiredAttributes(true);
          } else {
            container.classList.add("hidden");
            container.setAttribute("inert", "");
            clearLocalConveyanceRows();
            toggleRequiredAttributes(false);
          }
        });

        addRowButton.addEventListener("click", addRow);

        tbody.addEventListener("click", function (e) {
          if (e.target.classList.contains("remove-row-button")) {
            if (tbody.children.length > 1) {
              e.target.closest("tr").remove();
              calculateTotalLocalAmount(); // Update total after row removal
            } else {
              alert("You cannot remove the last row.");
            }
          }
        });

        // Initialize event listeners for existing rows
        addLocalConveyanceEventListeners();
      });

      // form save to create ta record
      async function handleFormSubmit(event) {
        event.preventDefault(); // Prevent default form submission behavior

        const form = event.target;
        const submitButton = document.getElementById("add-button");
        submitButton.disabled = true; // Disable the button to prevent multiple submissions
        const formData = new FormData();

        // Append text fields
        formData.append(
          "from_location",
          document.getElementById("from_location").value
        );
        formData.append(
          "from_location_other",
          document.getElementById("from_location_other").value
        );

        formData.append(
          "to_location",
          document.getElementById("to_location").value
        );
        formData.append(
          "to_location_other",
          document.getElementById("to_location_other").value
        );
        formData.append(
          "from_date",
          document.getElementById("from_date").value
        );
        formData.append(
          "from_time",
          document.getElementById("from_time").value
        );
        formData.append("to_date", document.getElementById("to_date").value);
        formData.append("to_time", document.getElementById("to_time").value);
        formData.append(
          "total_time",
          document.getElementById("total_time").value
        );
        formData.append("purpose", document.getElementById("purpose").value);
        formData.append(
          "travel_mode",
          document.getElementById("travel_mode").value
        );
        formData.append("total_km", document.getElementById("total_km").value);
        formData.append(
          "ticket_amount",
          document.getElementById("ticket_amount").value
        );
        formData.append(
          "fare_amount",
          document.getElementById("fare_amount").value
        );
        formData.append(
          "allowance_type",
          document.getElementById("allowance_type").value
        );
        formData.append(
          "final_da_amount",
          document.getElementById("final_da_amount").value
        );
        formData.append(
          "lodging_amount",
          document.getElementById("lodging_amount").value
        );
        formData.append(
          "day_stay_lodge",
          document.getElementById("day_stay_lodge").value
        );
        formData.append(
          "final_lodge_amount",
          document.getElementById("final_lodge_amount").value
        );
        formData.append(
          "final_halt_amount",
          document.getElementById("final_halt_amount").value
        );
        formData.append(
          "final_local_amount",
          document.getElementById("final_local_amount").value
        );
        formData.append(
          "total_amount",
          document.getElementById("total_amount").value
        );

        // Append file inputs
        const uploadTicketFile =
          document.getElementById("upload_ticket").files[0];
        if (uploadTicketFile) {
          formData.append("upload_ticket", uploadTicketFile);
        }

        const uploadLodgingFile =
          document.getElementById("upload_lodging").files[0];
        if (uploadLodgingFile) {
          formData.append("upload_lodging", uploadLodgingFile);
        }

        // Collect local conveyance data only if the checkbox is checked
        if (document.querySelector("#local_conveyance").checked) {
          const localConveyanceRows = document.querySelectorAll(
            "#local-conveyance-body tr"
          );
          const localConveyanceData = [];
          let hasInvalidFields = false; // Flag to check if any field is invalid

          localConveyanceRows.forEach((row) => {
            const date = row.querySelector('input[name="local_date[]"]').value;
            const from = row.querySelector('input[name="from_local[]"]').value;
            const to = row.querySelector('input[name="to_local[]"]').value;
            const purpose = row.querySelector('input[name="purpose[]"]').value;
            const mode = row.querySelector(
              'select[name="local_travel_mode[]"]'
            ).value;
            const amount = row.querySelector('input[name="local_amt[]"]').value;

            if (date && from && to && purpose && mode && amount) {
              localConveyanceData.push({
                local_date: date,
                from_local: from,
                to_local: to,
                purpose: purpose,
                local_travel_mode: mode,
                local_amt: amount,
              });
            } else {
              hasInvalidFields = true;
            }
          });

          /*if (hasInvalidFields) {
                            await Swal.fire({
                              title: "Error",
                              text: "Some local conveyance fields are missing or invalid. Please check and try again.",
                              icon: "error",
                            });
                            submitButton.disabled = false;
                            return;
                          }*/

          formData.append(
            "local_conveyance",
            JSON.stringify(localConveyanceData)
          );
          formData.append("local_conveyance_count", localConveyanceData.length);
        } else {
          // Handle the case where the checkbox is not checked
          formData.append("local_conveyance", JSON.stringify([]));
          formData.append("local_conveyance_count", 0);
        }

        try {
          // Log formData entries for debugging
          for (const [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
          }

          // Get the total amount from the form
          const totalAmount = formData.get("total_amount");

          // Show confirmation dialog
          const confirmation = await Swal.fire({
            title: "Confirm Submission",
            text: `Total Amount: ${totalAmount}. Do you want to proceed?`,
            icon: "info",
            showCancelButton: true,
            confirmButtonText: "Yes, submit",
            cancelButtonText: "No, cancel",
          });

          if (confirmation.isConfirmed) {
            // Make the POST request using Fetch API
            const response = await fetch(
              "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.create_record",
              {
                method: "POST",
                body: formData, // Use FormData object
              }
            );
            // Log the response
            const result = await response.json();
            console.log("Server response:", result);

            // Handle the response
            if (result.message.status === "success") {
              await Swal.fire({
                title: "Success",
                text: "Your TA has been added successfully!",
                icon: "success",
              });

              form.reset(); // Clear the form
              fetchData(); // Fetch updated data
              resetSelectElements(); // Reset select elements to default
              hideConditionalElements(); // Hide elements that were conditionally shown

              // Show "Please wait" overlay
              document.getElementById("please-wait-overlay").style.display =
                "flex";

              // Wait for 2 seconds before refreshing the page
              setTimeout(() => {
                location.reload(); // Refresh the page
              }, 2000); // Delay of 2000 milliseconds (2 seconds)
            } else {
              await Swal.fire({
                title: "Error",
                text: result.message || "Submission failed. Please try again.",
                icon: "error",
              });
            }
          } else {
            await Swal.fire({
              title: "Cancelled",
              text: "Your submission has been cancelled.",
              icon: "info",
            });
          }
        } catch (error) {
          console.error("Error:", error);
          await Swal.fire({
            title: "Error",
            text: "Submission failed. Please try again.",
            icon: "error",
          });
        } finally {
          submitButton.disabled = false; // Re-enable the button
        }
      }

      // Reset select elements to their default option
      function resetSelectElements() {
        document.querySelectorAll("#travel-form select").forEach((select) => {
          select.selectedIndex = 0;
        });
      }

      // Hide conditionally shown elements
      function hideConditionalElements() {
        document.querySelectorAll(".hidden").forEach((element) => {
          element.style.display = "none";
        });
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const cityNames = await fetchCityCategories();
        console.log("City Names:", cityNames); // Log the city names
        populateCityDropdown(cityNames, "from_location");
        populateCityDropdown(cityNames, "to_location");
        // Handle changes to the 'from_location' dropdown
        document
          .getElementById("from_location")
          .addEventListener("change", function () {
            handleOtherOption(this, "from_location_other_group");
            validateLocations(); // Call validation when from_location changes
          });
        // Handle changes to the 'to_location' dropdown
        document
          .getElementById("to_location")
          .addEventListener("change", function () {
            handleOtherOption(this, "to_location_other_group");
            validateLocations(); // Call validation when to_location changes
          });
      });
      function validateLocations() {
        const fromLocation = document.getElementById("from_location");
        const toLocation = document.getElementById("to_location");
        const submitButton = document.querySelector('button[type="submit"]');
        // Check if both locations are the same and not 'Other'
        if (
          fromLocation.value === toLocation.value &&
          fromLocation.value !== "Other"
        ) {
          alert("From and To locations cannot be the same.");
          document.getElementById("to_location").value = "";
          //toLocation.classList.add("field-error"); // Apply error styling to To location
          submitButton.disabled = true; // Disable the submit button
        } else {
          //toLocation.classList.remove("field-error"); // Remove error styling
          submitButton.disabled = false; // Enable the submit button
        }
      }
      function handleOtherOption(selectElement, otherFieldGroupId) {
        const otherFieldGroup = document.getElementById(otherFieldGroupId);
        const inputField = otherFieldGroup.querySelector("input"); // Find the input field within the group
        const selectedValue = selectElement.value;
        // Make the input field readonly or editable based on selection
        if (selectedValue === "Other") {
          //inputField.removeAttribute("readonly"); // Make it editable
          inputField.required = true;
          otherFieldGroup.classList.remove("hidden");
        } else {
          // inputField.value = ""; // Clear the input field
          // inputField.setAttribute("readonly", "readonly"); // Make it readonly
          inputField.required = false;
          otherFieldGroup.classList.add("hidden");
        }
      }

      document
        .getElementById("from_location_other")
        .addEventListener("change", function () {
          validateOtherLocations(); // Call validation when to_location changes
        });

      document
        .getElementById("to_location_other")
        .addEventListener("change", function () {
          validateOtherLocations(); // Call validation when to_location changes
        });
      function validateOtherLocations() {
        const fromLocationOther = document.getElementById(
          "from_location_other"
        ).value;
        const toLocationOther =
          document.getElementById("to_location_other").value;
        if (fromLocationOther === toLocationOther) {
          alert(
            "From and To locations cannot be the same when 'Other' is selected."
          );
          document.getElementById("to_location_other").value = "";
          submitButton.disabled = true; // Disable the submit button
        } else {
          //removeTooltip(toLocation); // Remove error styling
          submitButton.disabled = false; // Enable the submit button
        }
      }

      // Get city category doctype to access cities of destination
      async function fetchCityCategories() {
        try {
          const response = await fetch(
            "/api/method/travel_allowance.travel_allowance.doctype.city_category.city_category.get_city_categories"
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          // Log the response for debugging
          console.log("API Response:", data.message);
          if (data.message.status === "success") {
            // Extract and return only the city names
            const cityNames = data.message.message.map((item) => item.city);
            return cityNames;
          } else {
            console.error("Error fetching city categories:", data.message);
            return [];
          }
        } catch (error) {
          console.error("Error fetching city categories:", error);
          return [];
        }
      }
      function populateCityDropdown(cityNames, dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        // Clear existing options
        dropdown.innerHTML = '<option value="">Select a city...</option>';
        cityNames.forEach((city) => {
          const option = document.createElement("option");
          option.value = city; // Use the city name for the value
          option.textContent = city; // Use the city name for display
          dropdown.appendChild(option);
        });
        // Add 'Other' option if it does not exist
        if (![...dropdown.options].some((option) => option.value === "Other")) {
          const otherOption = document.createElement("option");
          otherOption.value = "Other";
          otherOption.textContent = "Other";
          dropdown.appendChild(otherOption);
        }
      }

      async function calculateDistance() {
        const fromSelect = document.getElementById("from_location");
        const toSelect = document.getElementById("to_location");
        const totalKmInput = document.getElementById("total_km");

        const fromOtherInput = document.getElementById("from_location_other");
        const toOtherInput = document.getElementById("to_location_other");

        const locationFrom =
          fromSelect.value === "Other"
            ? fromOtherInput.value
            : fromSelect.value;
        const locationTo =
          toSelect.value === "Other" ? toOtherInput.value : toSelect.value;

        if (locationFrom && locationTo) {
          try {
            const fromCoords = await getCoordinates(locationFrom);
            const toCoords = await getCoordinates(locationTo);

            if (fromCoords && toCoords) {
              const url = `http://router.project-osrm.org/route/v1/driving/${fromCoords.lon},${fromCoords.lat};${toCoords.lon},${toCoords.lat}?overview=false`;

              const response = await fetch(url);
              const data = await response.json();
              if (data.routes.length > 0) {
                const distance = data.routes[0].legs[0].distance; // Distance in meters
                const distanceKM = (distance / 1000).toFixed(2); // Convert to kilometers
                const distanceText = distanceKM + " km";
                document.getElementById(
                  "distanceResult"
                ).innerText = `Distance: ${distanceText}`;
                totalKmInput.value = distanceKM * 2; // Multiply by 2 for round trip
                console.log("Total Distance in KM:", distanceKM);
              } else {
                document.getElementById("distanceResult").innerText =
                  "Unable to calculate distance.";
              }
            } else {
              document.getElementById("distanceResult").innerText =
                "Invalid coordinates for one or both locations.";
            }
          } catch (error) {
            console.error("Error fetching distance:", error);
            document.getElementById("distanceResult").innerText =
              "Error fetching distance.";
          }
        } else {
          document.getElementById("distanceResult").innerText = "";
        }
      }

      async function getCoordinates(location) {
        // If location is 'Other', we need to handle it differently
        const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
          location
        )}`;

        const response = await fetch(geocodeUrl);
        const data = await response.json();

        if (data.length > 0) {
          // Here you can check for ambiguity based on the number of results returned
          if (data.length === 1) {
            return { lon: data[0].lon, lat: data[0].lat }; // Return coordinates if unique
          } else {
            // If multiple results, handle ambiguity (e.g., prompt user)
            handleAmbiguousResults(data, location);
            return null; // Return null to indicate failure
          }
        } else {
          throw new Error(`Coordinates not found for location: ${location}`);
        }
      }

      function handleAmbiguousResults(results, location) {
        // Present a list to the user for selection or alert them to provide more details
        const options = results
          .map(
            (result) =>
              `${result.display_name} (${result.address.city || ""}, ${
                result.address.state || ""
              })`
          )
          .join("\n");
        alert(
          `Multiple locations found for "${location}":\n${options}\nPlease be more specific.`
        );
      }

      // Function for calculating total duration time of travel
      async function calculateTotalDuration() {
        const fromDate = document.getElementById("from_date").value;
        const fromTime = document.getElementById("from_time").value;
        const toDate = document.getElementById("to_date").value;
        const toTime = document.getElementById("to_time").value;

        if (fromDate && fromTime && toDate && toTime) {
          const startDateTime = new Date(`${fromDate}T${fromTime}`);
          const endDateTime = new Date(`${toDate}T${toTime}`);

          // Client-side validation
          if (startDateTime > endDateTime) {
            alert("Start date-time should not be greater than end date-time.");
            document.getElementById("to_time").value = ""; // Reset the to_time field
            document.getElementById("to_date").value = "";
            return;
          }

          // Check if the start and end times are the same
          if (startDateTime.getTime() === endDateTime.getTime()) {
            alert("Start time and end time should not be the same.");
            document.getElementById("to_time").value = ""; // Reset the to_time field
            document.getElementById("to_date").value = "";
            return;
          }

          try {
            // Send data to the server for further validation and calculation
            const response = await fetch(
              "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.calculate_total_duration",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  from_date: fromDate,
                  from_time: fromTime,
                  to_date: toDate,
                  to_time: toTime,
                }),
              }
            );

            const data = await response.json();

            console.log("total time response:", data);

            // Check if response contains the expected structure
            if (response.ok && data.message) {
              if (data.message.status === "success") {
                document.getElementById("total_time").value =
                  data.message.total_hours || "N/A";
                document.getElementById(
                  "total_duration"
                ).textContent = `Total Duration: ${
                  data.total_duration || "N/A"
                }`;

                allowanceTypeSelect();
              } else {
                // Display error message from the server
                alert(
                  data.message.error || "An error occurred during calculation."
                );
                document.getElementById("to_time").value = ""; // Reset the to_time field
              }
            } else {
              alert("Unexpected response from server.");
              document.getElementById("to_time").value = ""; // Reset the to_time field
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while calculating the total duration.");
            document.getElementById("to_time").value = ""; // Reset the to_time field
          }
        }
      }

      // Function to fetch and update allowance amounts in p tag
      function fetchAndUpdateAllowances() {
        const allowanceType = document.getElementById("allowance_type").value;
        const toLocation = document.getElementById("to_location").value;
        if (allowanceType || toLocation) {
          fetch(
            `/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_allowances?to_location=${encodeURIComponent(
              toLocation
            )}`
          )
            .then((response) => response.json())
            .then((data) => {
              if (data) {
                const allowancesData = data.message;
                console.log("Allowances:", allowancesData);
                // Extract and set DA amount
                const daAmount = allowancesData.DA || "No DA amount available";
                document.getElementById(
                  "da-amount"
                ).textContent = `DA Amount: ${daAmount}`;
                // Extract and set Lodging amount
                const lodgingAmount =
                  allowancesData.Lodging || "No Lodging amount available";
                document.getElementById(
                  "lodging-amount"
                ).textContent = `Lodging Amount: ${lodgingAmount}`;
                // Extract and set Halting amount
                const haltingAmount =
                  allowancesData.Halting || "No Halting amount available";
                document.getElementById(
                  "halting-amount"
                ).textContent = `Halting Amount: ${haltingAmount}`;
                calculateTotalDuration();
                allowanceTypeSelect();
              } else {
                console.error("Error fetching allowances:", data.error);
              }
            })
            .catch((error) => {
              console.error("Fetch error:", error);
            });
        }
      }

      // Event listeners on to_location field( destination input field)
      document
        .getElementById("to_location")
        .addEventListener("change", fetchAndUpdateAllowances);

      // Event listeners for handling the travel mode section and calculate fare amount
      document.addEventListener("DOMContentLoaded", function () {
        const travelMode = document.getElementById("travel_mode");
        const allowanceType = document.getElementById("allowance_type");
        const fromLocation = document.getElementById("from_location");
        const toLocation = document.getElementById("to_location");
        const fromDate = document.getElementById("from_date");
        const fromTime = document.getElementById("from_time");
        const toDate = document.getElementById("to_date");
        const toTime = document.getElementById("to_time");
        const totalKmGroup = document.getElementById("total_km_group");
        const ticketAmountGroup = document.getElementById(
          "ticket_amount_group"
        );
        const totalKmInput = document.getElementById("total_km");
        const ticketAmountInput = document.getElementById("ticket_amount");
        const lodgingAmountGroup = document.getElementById(
          "lodging_amount_group"
        );
        const dayStayLodgeGroup = document.getElementById(
          "day_stay_lodge_group"
        );
        const finalLodgingAmount = document.getElementById(
          "final_lodge_amount_summary"
        );
        const finalHaltingAmount = document.getElementById(
          "final_halt_amount_summary"
        );

        const finalDaAmount = document.getElementById("da_amount_summary");
        const lodgingAmount = document.getElementById("lodging_amount");

        const dayStayLodgeInput = document.getElementById("day_stay_lodge");
        const uploadTicketGroup = document.getElementById(
          "upload_ticket_group"
        );
        const uploadTicketInput = document.getElementById("upload_ticket");

        const uploadLodgingGroup = document.getElementById(
          "upload_lodging_group"
        );
        const uploadLodgingInput = document.getElementById("upload_lodging");
        // Add event listener to travel mode dropdown
        travelMode.addEventListener("change", function () {
          const selectedValue = this.value;
          // Check if locations and dates are filled
          if (!fromLocation.value || !toLocation.value) {
            alert("Please select the locations first.");
            travelMode.value = ""; // Reset the dropdown selection
            return;
          }
          if (
            !fromDate.value ||
            !fromTime.value ||
            !toDate.value ||
            !toTime.value
          ) {
            // If any of the date or time fields are empty, show an alert and reset the dropdown
            alert(
              "Please fill in all date and time fields before selecting a travel mode."
            );
            travelMode.value = ""; // Reset the dropdown selection
            return;
          }
          // Show/hide fields based on travel mode
          if (selectedValue === "Bike" || selectedValue === "Car") {
            document.getElementById("ticket_amount").value = 0;
            totalKmGroup.classList.remove("hidden");
            ticketAmountGroup.classList.add("hidden");
            uploadTicketGroup.classList.add("hidden");
            totalKmInput.required = true; // Make total km input mandatory
            ticketAmountInput.required = false; // Remove requirement from ticket amount
            uploadTicketInput.required = false;
            calculateDistance();
          } else if (selectedValue === "Train" || selectedValue === "Bus") {
            document.getElementById("total_km").value = 0;
            ticketAmountGroup.classList.remove("hidden");
            uploadTicketGroup.classList.remove("hidden");
            totalKmGroup.classList.add("hidden");
            ticketAmountInput.required = true; // Make ticket amount input mandatory
            totalKmInput.required = false; // Remove requirement from total km
            uploadTicketInput.required = true;
          } else {
            document.getElementById("ticket_amount").value = 0;
            document.getElementById("total_km").value = 0;
            totalKmGroup.classList.add("hidden");
            ticketAmountGroup.classList.add("hidden");
            uploadTicketGroup.classList.add("hidden");
            totalKmInput.required = false; // Remove requirement
            ticketAmountInput.required = false; // Remove requirement
            uploadTicketInput.required = false;
          }
          // Calculate fare amount based on mode of travel
          calculateFareAmount(selectedValue);
        });
        // Add event listener to input fields for recalculation
        totalKmInput.addEventListener("input", function () {
          calculateFareAmount(travelMode.value);
        });
        ticketAmountInput.addEventListener("input", function () {
          calculateFareAmount(travelMode.value);
        });
        // Function to calculate fare amount
        function calculateFareAmount(mode) {
          let fareAmount = 0;
          if (mode === "Bike" || mode === "Car") {
            const totalKm = parseFloat(totalKmInput.value);
            if (!isNaN(totalKm)) {
              if (mode === "Bike") {
                fareAmount = totalKm * 4; // 4 Rs per km for bike
              } else if (mode === "Car") {
                fareAmount = totalKm * 10; // 10 Rs per km for car
              }
            }
          } else if (mode === "Train" || mode === "Bus") {
            const ticketAmount = parseFloat(ticketAmountInput.value);
            if (!isNaN(ticketAmount)) {
              fareAmount = ticketAmount; // Use ticket amount as fare
            }
          }
          // Display fare amount
          console.log(`Fare Amount: ${fareAmount} Rs`);
          document
            .getElementById("fare_amount_group")
            .classList.remove("hidden");
          document.getElementById("fare_amount").value = fareAmount;
          document.getElementById(
            "fare"
          ).textContent = `Fare Amount: ${fareAmount}`;
          document
            .getElementById("fare_amount_summary")
            .classList.remove("hidden");
          document.querySelector(
            `#fare_amount_summary .amount-value`
          ).textContent = "" + fareAmount.toFixed(2);
          calculateTotalAmount();
        }
        // Add event listener to allowance type dropdown
        allowanceType.addEventListener("change", function () {
          const selectedValue = this.value;

          // Check if locations and dates are filled
          if (!fromLocation.value || !toLocation.value) {
            alert("Please select the locations first.");
            allowanceType.value = ""; // Reset the dropdown selection
            return;
          }
          if (
            !fromDate.value ||
            !fromTime.value ||
            !toDate.value ||
            !toTime.value
          ) {
            // If any of the date or time fields are empty, show an alert and reset the dropdown
            alert(
              "Please fill in all date and time fields before selecting an allowance type."
            );
            allowanceType.value = ""; // Reset the dropdown selection
            return;
          }
          // Show/hide fields based on allowance type
          if (selectedValue === "Lodging") {
            lodgingAmountGroup.classList.remove("hidden");
            uploadLodgingGroup.classList.remove("hidden");
            dayStayLodgeGroup.classList.remove("hidden");
            finalLodgingAmount.classList.remove("hidden");
            finalHaltingAmount.classList.add("hidden");
            finalDaAmount.classList.add("hidden");
            lodgingAmount.required = true;
            dayStayLodgeInput.required = true;
            uploadLodgingInput.required = true;
          } else if (selectedValue === "DA and Lodging") {
            lodgingAmountGroup.classList.remove("hidden");
            uploadLodgingGroup.classList.remove("hidden");
            dayStayLodgeGroup.classList.remove("hidden");
            finalLodgingAmount.classList.remove("hidden");
            finalDaAmount.classList.remove("hidden");
            finalHaltingAmount.classList.add("hidden");
            lodgingAmount.required = true;
            dayStayLodgeInput.required = true;
            uploadLodgingInput.required = true;
          } else if (selectedValue === "DA") {
            finalDaAmount.classList.remove("hidden");
            lodgingAmountGroup.classList.add("hidden");
            uploadLodgingGroup.classList.add("hidden");
            dayStayLodgeGroup.classList.add("hidden");
            finalLodgingAmount.classList.add("hidden");
            finalHaltingAmount.classList.add("hidden");
            lodgingAmount.required = false;
            dayStayLodgeInput.required = false;
            uploadLodgingInput.required = false;
          } else if (selectedValue === "Halting") {
            lodgingAmountGroup.classList.add("hidden");
            uploadLodgingGroup.classList.add("hidden");

            dayStayLodgeGroup.classList.add("hidden");
            finalDaAmount.classList.add("hidden");
            finalLodgingAmount.classList.add("hidden");
            finalHaltingAmount.classList.remove("hidden");
            lodgingAmount.required = false;
            dayStayLodgeInput.required = false;
            uploadLodgingInput.required = false;
          } else {
            lodgingAmountGroup.classList.add("hidden");
            uploadLodgingGroup.classList.add("hidden");
            dayStayLodgeGroup.classList.add("hidden");
            finalDaAmount.classList.add("hidden");
            finalLodgingAmount.classList.add("hidden");
            finalHaltingAmount.classList.add("hidden");
            lodgingAmount.required = false;
            dayStayLodgeInput.required = false;
            uploadLodgingInput.required = false;
          }
          allowanceTypeSelect();
        });
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Fields that should trigger both allowanceTypeSelect and calculateTotalDuration
        const fields = [
          "from_date",
          "from_time",
          "to_date",
          "to_time",
          "to_location",
          "allowance_type",
          "travel_mode",
          "total_km",
          "ticket_amount",
          "lodging_amount", // user input amount
          "day_stay_lodge",
          "total_time",
        ];

        // Attach both calculateTotalDuration and allowanceTypeSelect to each field
        fields.forEach((field) => {
          const element = document.getElementById(field);
          if (element) {
            element.addEventListener("change", function () {
              calculateTotalDuration(); // Call calculateTotalDuration first
              allowanceTypeSelect(); // Call allowanceTypeSelect after
            });
          }
        });
      });

      // Main function to handle allowance type selection
      function allowanceTypeSelect() {
        const toLocation = document.getElementById("to_location").value;
        const allowanceType = document.getElementById("allowance_type").value;
        if (allowanceType === "DA") {
          document.getElementById("lodging_amount").value = 0;
          document.getElementById("final_lodge_amount").value = 0;
          document.getElementById("final_halt_amount").value = 0;
          document.getElementById("day_stay_lodge").value = 0;

          calculateDAAmount();
        } else if (allowanceType === "Lodging") {
          document.getElementById("final_da_amount").value = 0;
          document.getElementById("final_halt_amount").value = 0;

          calculateLodgingAmount();
        } else if (allowanceType === "Halting") {
          document.getElementById("final_da_amount").value = 0;
          document.getElementById("lodging_amount").value = 0;
          document.getElementById("final_lodge_amount").value = 0;
          document.getElementById("day_stay_lodge").value = 0;
          calculateHaltingAmount();
        } else if (allowanceType === "DA and Lodging") {
          document.getElementById("final_halt_amount").value = 0;

          calculateDAAmount();
          calculateLodgingAmount();
        }
      }

      // calculate total amount
      function calculateTotalAmount() {
        // Get input values and parse them as floats
        const fareAmount =
          parseFloat(document.getElementById("fare_amount").value) || 0;
        const daAmount =
          parseFloat(document.getElementById("final_da_amount").value) || 0;
        const haltAmount =
          parseFloat(document.getElementById("final_halt_amount").value) || 0;
        const lodgeAmount =
          parseFloat(document.getElementById("final_lodge_amount").value) || 0;
        const localAmount =
          parseFloat(document.getElementById("final_local_amount").value) || 0;
        console.log("fare:", fareAmount);
        console.log("daAmount:", daAmount);
        console.log("haltAmount:", haltAmount);
        console.log("lodgeAmount:", lodgeAmount);
        console.log("localAmount:", localAmount);
        // Construct URL with parameters for the server call
        const url = new URL(
          "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.calculate_total_amount",
          window.location.origin
        );
        // Append query parameters
        url.searchParams.append("fare_amount", fareAmount);
        url.searchParams.append("da_amount", daAmount);
        url.searchParams.append("halt_amount", haltAmount);
        url.searchParams.append("lodge_amount", lodgeAmount);
        url.searchParams.append("local_amount", localAmount);
        // Make the request using fetch
        fetch(url)
          .then((response) => {
            // Check if the response is OK and convert it to JSON
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            // Check if the response contains a message with the total amount
            if (data && data.message !== undefined) {
              console.log("Total Amount:", data.message.total_amount);
              const totatAmount = data.message.total_amount;
              // Update the total amount display in the DOM
              document.getElementById(
                "total-amount"
              ).textContent = `Total Amount: ${totatAmount}`;
              document
                .getElementById("amount-summary")
                .classList.remove("hidden");
              document
                .getElementById("tatal_amount_group")
                .classList.remove("hidden");
              document.getElementById("total_amount").value = totatAmount;

              document
                .getElementById("total_amount_summary")
                .classList.remove("hidden");
              document.querySelector(
                `#total_amount_summary .amount-value`
              ).textContent = "" + totatAmount.toFixed(2);
            } else {
              // Handle case where response does not contain the expected data
              console.error("Error fetching total amount:", data);
              alert("Error calculating total amount. Please try again.");
              document.getElementById("total_amount").value = 0;
            }
          })
          .catch((error) => {
            // Handle network or other errors
            console.error("Fetch error:", error);
            alert(
              "An error occurred while calculating the total amount. Please check your connection and try again."
            );
          });
      }

      // Calculates DA amount
      function calculateDAAmount() {
        const totalTime = document.getElementById("total_time").value;
        const daAmountContent =
          document.getElementById("da-amount").textContent;
        console.log("DA Amount Content:", daAmountContent);
        // Extract the numeric value from the DA amount text content
        const daAmountMatch = daAmountContent.match(
          /DA Amount:\s*(\d+(\.\d+)?)/
        );
        const daAmount = daAmountMatch ? parseFloat(daAmountMatch[1]) : 0; // Use 0 as default
        // Construct URL with parameters
        const url = new URL(
          "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.calculate_da_amount",
          window.location.origin
        );
        url.searchParams.append("total_time", totalTime);
        url.searchParams.append("da_amount", daAmount);
        // Make the request using fetch
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            if (data && data.message !== undefined) {
              console.log("Final DA:", data.message);
              const daAmount = data.message;
              document.getElementById("final_da_amount").value = daAmount;

              document
                .getElementById("da_amount_summary")
                .classList.remove("hidden");
              document.querySelector(
                `#da_amount_summary .amount-value`
              ).textContent = "" + daAmount.toFixed(2);

              calculateTotalAmount();
            } else {
              document.getElementById("final_da_amount").value = 0;
              handleError("Error fetching final DA amount", 0);
            }
          })
          .catch((error) => handleError("Fetch error", error));
      }
      // Calculates Lodging amount
      function calculateLodgingAmount() {
        const lodgingAmountContent =
          document.getElementById("lodging_amount").value;
        const inputLodgingAmount = parseFloat(lodgingAmountContent) || 0;
        // Extract the numeric value from the lodging-amount text content
        const lodgingAmountText =
          document.getElementById("lodging-amount").textContent;
        const lodgingAmountMatch = lodgingAmountText.match(
          /Lodging Amount:\s*(\d+(\.\d+)?)/
        );
        const lodgingLimit = lodgingAmountMatch
          ? parseFloat(lodgingAmountMatch[1])
          : 0;
        const inputStayDays =
          parseFloat(document.getElementById("day_stay_lodge").value) || 0;
        // Retrieve total time duration in hours from the input field
        const totalTimeContent = document.getElementById("total_time").value;
        const totalHours = parseFloat(totalTimeContent) || 0;
        const totalDurationInDays = totalHours / 24; // Convert hours to days
        console.log("Lodging limit:", lodgingLimit);
        console.log("Input stay days:", inputStayDays);
        console.log("Total duration in days:", totalDurationInDays);
        // Check if inputStayDays exceeds totalDurationDays
        if (inputStayDays > totalDurationInDays) {
          console.error("Stay days cannot exceed total duration.");
          // Optionally, show a user-friendly message on the UI
          alert(
            "Total days stay in lodge cannot exceed the total duration of your journey."
          );
          document.getElementById("day_stay_lodge").value = 0; // Reset lodging amount
        } else {
          // Construct URL with parameters
          const url = new URL(
            "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.calculate_lodging_amount",
            window.location.origin
          );
          url.searchParams.append("input_lodging_amount", inputLodgingAmount);
          url.searchParams.append("stay_days", inputStayDays);
          url.searchParams.append("lodging_limit", lodgingLimit); // Send the limit if needed
          // Make the request using fetch
          fetch(url)
            .then((response) => response.json())
            .then((data) => {
              if (data && data.message !== undefined) {
                console.log("Final Lodging Amount:", data.message);
                const lodgeAmount = data.message;
                document.getElementById("final_lodge_amount").value =
                  lodgeAmount;
                document
                  .getElementById("final_lodge_amount_summary")
                  .classList.remove("hidden");
                document.querySelector(
                  `#final_lodge_amount_summary .amount-value`
                ).textContent = "" + lodgeAmount.toFixed(2);
                calculateTotalAmount();
              } else {
                handleError("Error fetching final lodging amount", 0);
              }
            })
            .catch((error) => handleError("Fetch error", error));
        }
      }
      function calculateHaltingAmount() {
        // Extract the numeric value from the lodging-amount text content
        const haltingAmountText =
          document.getElementById("halting-amount").textContent;
        const HaltingAmountMatch = haltingAmountText.match(
          /Halting Amount:\s*(\d+(\.\d+)?)/
        );
        const HaltingLimit = HaltingAmountMatch
          ? parseFloat(HaltingAmountMatch[1])
          : 0;
        // const inputStayDays = parseFloat(document.getElementById("day_stay_halt").value) || 0;
        // Retrieve total time duration in hours from the input field
        const totalTimeContent = document.getElementById("total_time").value;
        const totalHours = parseFloat(totalTimeContent) || 0;
        const totalDurationInDays = totalHours / 24; // Convert hours to days
        // Check if inputStayDays exceeds totalDurationDays
        if (totalHours < 4) {
          alert(
            "You are not eligible for DA because your total travel duration is less than 4 hours."
          );
          document.getElementById("final_halt_amount").value = 0;
        } else {
          // Construct URL with parameters
          const url = new URL(
            "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.calculate_halting_amount",
            window.location.origin
          );
          url.searchParams.append("total_time", totalTimeContent);
          url.searchParams.append("halting_limit", HaltingLimit); // Send the limit if needed
          // Make the request using fetch
          fetch(url)
            .then((response) => response.json())
            .then((data) => {
              if (data && data.message !== undefined) {
                console.log("Final Halting Amount:", data.message);
                const haltAmount = data.message;
                document.getElementById("final_halt_amount").value = haltAmount;
                document
                  .getElementById("final_halt_amount_summary")
                  .classList.remove("hidden");
                document.querySelector(
                  `#final_halt_amount_summary .amount-value`
                ).textContent = "" + haltAmount.toFixed(2);
                calculateTotalAmount();
              } else {
                handleError("Error fetching final lodging amount", 0);
              }
            })
            .catch((error) => handleError("Fetch error", error));
        }
      }
      // Handles error logging and updating the final DA amount
      function handleError(message, defaultValue) {
        console.error(message);
        document.getElementById("final_da_amount").value = defaultValue;
        document.getElementById("final_lodge_amount").value = defaultValue;
        document.getElementById("final_halt_amount").value = defaultValue;
      }

      // Initial data fetch ta-records if exists
      fetchData();

      // Fetch data from server
      async function fetchData() {
        try {
          const response = await fetch(
            "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_list"
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("getlist data:", data);
          const tableData = document.getElementById("taRecordTable");
          const tableBody = document.querySelector("#taRecordTable tbody");
          const mainContainer = document.querySelector(".main-container");
          /*const tableData = document.getElementById("excel-canvas");*/
          const tableHeading = document.getElementById("table-heading");
          const submitBtn = document.getElementById("ta-submit-btn");
          const noDataMsg = document.getElementById("no-records-message");
          const createbtn = document.querySelector(".create-btn");

          // Clear previous table data
          tableBody.innerHTML = "";

          // Check if there are records
          if (data.message.length === 0) {
            // No data, display appropriate message
            tableData.style.display = "none";
            tableHeading.style.display = "none";
            submitBtn.style.display = "none";
            noDataMsg.style.display = "block";
            mainContainer.style.display = "none";
          } else {
            createbtn.style.display = "block";
            // Data exists, populate the table
            data.message.forEach((record, index) => {
              const row = document.createElement("tr");

              if (record.status === "Pending") {
                row.classList.add("pending-row");
              } else if (record.status === "Approved") {
                row.classList.add("approved-row");
              } else if (record.status === "Reject") {
                row.classList.add("reject-row");
              }

              // Create cells for each piece of data
              row.innerHTML = `
                                      <td class="d-none">${record.name}</td>
                                      <td class="fixed-sr">${index + 1}</td>

                                      <td>
                                        <span class="${
                                          record.status === "Reject"
                                            ? "clickable"
                                            : ""
                                        }"
                                              onclick="${
                                                record.status === "Reject"
                                                  ? `fetchRejectionReason('${record.name}')`
                                                  : ""
                                              }"
                                              style="${
                                                record.status === "Reject"
                                                  ? "cursor: pointer;"
                                                  : "cursor: default;"
                                              }">
                                          ${record.status}
                                        </span>
                                      </td>
                                   <td>
            <div class="tracker">
              <!-- Stage 1: Reporting Person -->
              <span class="stage ${
                record.status_stage_1
                  ? getStatusClass(record.status_stage_1)
                  : "stage-null"
              }" title="${
                record.status_stage_1
                  ? record.status_stage_1 + " from Reporting Person"
                  : "Not sent to Reporting Person"
              }">
                ${
                  record.status_stage_1 === "Pending"
                    ? '<img src="/assets/travel_allowance/images/Pending_new.png" alt="Pending" />'
                    : record.status_stage_1 === "Approved"
                    ? '<img src="/assets/travel_allowance/images/Approved_new.png" alt="Approved" />'
                    : record.status_stage_1 === "Reject"
                    ? '<img src="/assets/travel_allowance/images/rejected_new.png" alt="Reject" />'
                    : record.status_stage_1 === ""
                    ? '<img src="/assets/travel_allowance/images/disable.png" alt="Not Applicable" />'
                    : ""
                }
              </span>

              <span class="line ${
                record.status_stage_1
                  ? getLineClass(record.status_stage_2)
                  : "line-null"
              }"></span>

              <!-- Stage 2: Skip Level -->
              <span class="stage ${
                record.status_stage_2
                  ? getStatusClass(record.status_stage_2)
                  : "stage-null"
              }" title="${
                record.status_stage_2
                  ? record.status_stage_2 + " from Skip Level"
                  : "Not sent to Skip Level"
              }">
                ${
                  record.status_stage_2 === "Pending"
                    ? '<img src="/assets/travel_allowance/images/Pending_new.png" alt="Pending" />'
                    : record.status_stage_2 === "Approved"
                    ? '<img src="/assets/travel_allowance/images/Approved_new.png" alt="Approved" />'
                    : record.status_stage_2 === "Reject"
                    ? '<img src="/assets/travel_allowance/images/rejected_new.png" alt="Reject" />'
                    : record.status_stage_2 === ""
                    ? '<img src="/assets/travel_allowance/images/disable.png" alt="Not Applicable" />'
                    : ""
                }
              </span>

              <span class="line ${
                record.status_stage_2
                  ? getLineClass(record.status_stage_3)
                  : "line-null"
              }"></span>

              <!-- Stage 3: TA -->
              <span class="stage ${
                record.status_stage_3
                  ? getStatusClass(record.status_stage_3)
                  : "stage-null"
              }" title="${
                record.status_stage_3
                  ? record.status_stage_3 + " from TA Team"
                  : "Not sent to TA Team"
              }">
                ${
                  record.status_stage_3 === "Pending"
                    ? '<img src="/assets/travel_allowance/images/Pending_new.png" alt="Pending" />'
                    : record.status_stage_3 === "Approved"
                    ? '<img src="/assets/travel_allowance/images/Approved_new.png" alt="Approved" />'
                    : record.status_stage_3 === "Reject"
                    ? '<img src="/assets/travel_allowance/images/rejected_new.png" alt="Reject" />'
                    : record.status_stage_3 === ""
                    ? '<img src="/assets/travel_allowance/images/disable.png" alt="Not Applicable" />'
                    : ""
                }
              </span>
            </div>
          </td>

                                      <td>
                                        ${
                                          record.status === "Draft"
                                            ? `<div class="action-btns" data-id="${record.name}">

                                                  <div class="delete-btn" onclick="deleteRecord('${record.name}')">
                                                    <img src='/files/delete_11540197.png' alt="Delete" width="20">
                                                  </div>
                                               </div>`
                                            : ""
                                        }
                                      </td>

                                      <td>${record.from_location}</td>
                                      <td>${record.from_date}</td>
                                      <td>${record.from_time}</td>
                                      <td>${record.to_location}</td>
                                      <td>${record.to_date}</td>
                                      <td>${record.to_time}</td>
                                      <td>${record.total_time}</td>
                                      <td>${record.purpose}</td>
                                      <td>${record.travel_mode}</td>
                                      <td>${record.total_km}</td>
                                      <td>${record.ticket_amount}</td>
                                      <td>${record.fare_amount}</td>

                                    <!--  <td>${record.allowance_type}</td>-->
                                      <td>${record.final_da_amount}</td>
                                      <td>${record.final_halt_amount}</td>
                                      <td>${record.final_lodge_amount}</td>
                                      <td>
                                        <span class="clickable-cell"
                                              onclick="${
                                                record.final_local_amount &&
                                                record.final_local_amount.trim() !==
                                                  "-" &&
                                                parseFloat(
                                                  record.final_local_amount
                                                ) !== 0
                                                  ? `fetchLocalConveyance('${record.name}')`
                                                  : ""
                                              }"
                                              title="${
                                                record.final_local_amount &&
                                                record.final_local_amount.trim() !==
                                                  "-" &&
                                                parseFloat(
                                                  record.final_local_amount
                                                ) !== 0
                                                  ? "Click for Local details"
                                                  : ""
                                              }"
                                              style="${
                                                record.final_local_amount &&
                                                record.final_local_amount.trim() !==
                                                  "-" &&
                                                parseFloat(
                                                  record.final_local_amount
                                                ) !== 0
                                                  ? ""
                                                  : "pointer-events: none; color: gray;"
                                              }">
                                          ${record.final_local_amount || "-"}
                                        </span>
                                      </td>


                                      <td>${
                                        record.upload_ticket
                                          ? `<a href="${record.upload_ticket}" target="_blank">View</a>`
                                          : "-"
                                      }</td>
                                      <td>${
                                        record.upload_lodging
                                          ? `<a href="${record.upload_lodging}" target="_blank">View</a>`
                                          : "-"
                                      }</td>
                                       <td class="fixed-tot">${
                                         record.total_amount
                                       }</td>

                                        <td>${timeAgo(record.modified)}</td>
                                  `;

              // Append the row to the table body
              tableBody.appendChild(row);

              // Add click event listener to each row (except for 'final_local_amount' click)
              // Assign a click event to the entire row
              row.onclick = (event) => {
                // Check if the clicked target is not one of the specific cells
                const target = event.target;
                const isClickableCell =
                  target.classList.contains("clickable") ||
                  target.classList.contains("clickable-cell") || // local amount cell
                  target.closest("a") || // upload ticket and upload lodging
                  target.closest(".delete-btn"); // delete button

                if (!isClickableCell) {
                  openDialogWithRowData(record);
                }
              };

              // Helper function to get the CSS class based on status
              function getStatusClass(status) {
                switch (status) {
                  case "Pending":
                    return "stage-pending";
                  case "Approved":
                    return "stage-approved";
                  case "Reject":
                    return "stage-reject";
                  default:
                    return "stage-null";
                }
              }
              // Helper function to get the CSS class for lines based on status
              function getLineClass(status) {
                switch (status) {
                  case "Pending":
                    return "line-pending";
                  case "Approved":
                    return "line-approved";
                  case "Reject":
                    return "line-reject";
                  default:
                    return "line-null";
                }
              }
            });

            // Show data if present
            tableData.style.display = "block";
            tableHeading.style.display = "block";
            submitBtn.style.display = "block";
            noDataMsg.style.display = "none";
          }
        } catch (error) {
          console.error("Error fetching data:", error);

          // Optionally display an error message
          document.getElementById("main-content").innerHTML =
            "<p>There was an error fetching the data. Please try again later.</p>";
        }
      }

      /***********pagination script starts here**********************/

      // Function to open the Bootstrap modal and display the record details
      function openDialogWithRowData(record) {
        const dialogContent = document.getElementById("dialogContent");

        // Populate the modal body with labels and input fields for the record details
        dialogContent.innerHTML = `
        <div class="form-group">
          <label for="fromLocation">From Location:</label>
          <input type="text" class="form-control" id="fromLocation" value="${record.from_location}" readonly>
        </div>
        <div class="form-group">
          <label for="toLocation">To Location:</label>
          <input type="text" class="form-control" id="toLocation" value="${record.to_location}" readonly>
        </div>
        <div class="form-group">
          <label for="totalKM">Total KM:</label>
          <input type="text" class="form-control" id="totalKM" value="${record.total_km}" readonly>
        </div>
        <!-- Add other fields as needed -->
      `;

        // Show the modal using Bootstrap's modal method
        $("#dataDialog").modal("show");
      }

      // Function to close the Bootstrap modal
      function closeDialog() {
        // Hide the modal using Bootstrap's modal method
        $("#dataDialog").modal("hide");
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Get the close button and the popup container
        const closeBtn = document.querySelector(".dynamic-popup-close-btn");
        const popup = document.getElementById("local-conveyance-popup");

        // Add click event listener to the close button
        closeBtn.addEventListener("click", function () {
          popup.style.display = "none";
        });

        // Optionally, close the popup when clicking outside of the popup content
        popup.addEventListener("click", function (event) {
          if (event.target === popup) {
            popup.style.display = "none";
          }
        });
      });

      function timeAgo(dateString) {
        const now = new Date();
        const modifiedDate = new Date(dateString);
        const diffInSeconds = Math.floor((now - modifiedDate) / 1000);

        const units = [
          { name: "year", seconds: 60 * 60 * 24 * 365 },
          { name: "month", seconds: 60 * 60 * 24 * 30 },
          { name: "day", seconds: 60 * 60 * 24 },
          { name: "hour", seconds: 60 * 60 },
          { name: "minute", seconds: 60 },
          { name: "second", seconds: 1 },
        ];

        for (const unit of units) {
          const interval = Math.floor(diffInSeconds / unit.seconds);
          if (interval >= 1) {
            return `${interval} ${unit.name}${interval > 1 ? "s" : ""} ago`;
          }
        }
        return "just now";
      }

      // fetch the local conveyance data from child table
      async function fetchLocalConveyance(recordId) {
        try {
          const response = await fetch(
            `/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_child_records?parent_id=${recordId}`
          );
          const result = await response.json();

          // Assuming the response is in the form { message: [...] }
          const data = result.message;

          const container = document.getElementById(
            "local-conveyance-container"
          );
          container.innerHTML = "";

          if (!data || data.length === 0) {
            container.textContent = "No local conveyance records found.";
          } else {
            const table = document.createElement("table");
            table.className = "dynamic-table";

            const thead = document.createElement("thead");
            const trHead = document.createElement("tr");

            // Define the custom headers
            const headers = [
              { key: "local_date", label: "Date" },
              { key: "from_local", label: "From" },
              { key: "to_local", label: "To" },
              { key: "local_travel_mode", label: "Travel Mode" },
              { key: "purpose", label: "Purpose" },
              { key: "local_amt", label: "Amount" },
            ];

            // Create table headers
            headers.forEach((header) => {
              const th = document.createElement("th");
              th.textContent = header.label;
              th.style.textAlign = "center";
              trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            const tbody = document.createElement("tbody");
            let totalAmount = 0;

            data.forEach((record) => {
              const tr = document.createElement("tr");
              headers.forEach((header) => {
                const td = document.createElement("td");
                if (header.key === "local_date") {
                  td.textContent = formatDateToDDMMYYYY(record[header.key]); // Format date
                } else if (header.key === "local_amt") {
                  // Convert the value to a float and format it with two decimal places
                  let amount = parseFloat(record[header.key] || 0).toFixed(2);
                  td.textContent = amount;
                } else {
                  td.textContent = record[header.key] || ""; // Handle undefined values gracefully
                }
                td.style.textAlign = "center";
                tr.appendChild(td);

                // Accumulate the total amount
                if (header.key === "local_amt") {
                  td.style.textAlign = "right";
                  totalAmount += parseFloat(record[header.key] || 0); // Convert to float and add to total
                }
              });
              tbody.appendChild(tr);
            });

            // Create a footer row for the total
            const trTotal = document.createElement("tr");
            trTotal.className = "total-row";

            headers.forEach((header) => {
              const td = document.createElement("td");
              if (header.key === "local_amt") {
                td.textContent = `Total ${totalAmount.toFixed(2)}`; // Display the total amount
                td.colSpan = headers.length; // Span across all columns if desired
                td.style.textAlign = "right"; // Align text to the right
                trTotal.appendChild(td);
              } else {
                td.textContent = "";
                trTotal.appendChild(td);
              }
            });

            tbody.appendChild(trTotal);
            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
          }

          document.getElementById("local-conveyance-popup").style.display =
            "block";
        } catch (error) {
          console.error("Error fetching local conveyance records:", error);
          const container = document.getElementById(
            "local-conveyance-container"
          );
          container.textContent = "Error fetching records.";
          document.getElementById("local-conveyance-popup").style.display =
            "block";
        }
      }
      function formatDateToDDMMYYYY(dateString) {
        // Format date from YYYY-MM-DD to DD-MM-YYYY
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      }
      // Function to fetch and display the rejection reason
      async function fetchRejectionReason(recordId) {
        try {
          // Fetch rejection reason from the server
          const response = await fetch(
            `/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.get_rejection_reason?record=${recordId}`
          );
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const result = await response.json();
          console.log("API Response:", result);

          if (result && result.message) {
            // Display the rejection reason
            const reason = result.message.reason || "No reason provided";
            console.log("Rejection Reason:", reason);

            Swal.fire({
              title: "Rejection Reason",
              html: `<textarea readonly style="width: 100%; height: 100px; padding: 10px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">${reason}</textarea>`,
              icon: "info",
              confirmButtonText: "OK",
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Unable to fetch rejection reason or no reason provided.",
            });
          }
        } catch (error) {
          console.error("Error:", error);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "An error occurred while fetching the rejection reason.",
          });
        }
      }

      // Delete record on click of delete button icon of particular row
      async function deleteRecord(recordName) {
        const selectedRecords = [recordName]; // Single record for deletion
        console.log(selectedRecords);

        // Confirm deletion with the user using SweetAlert
        Swal.fire({
          title: `Are you sure you want to delete this record ?`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, delete it!",
          cancelButtonText: "No, keep it",
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              // Log the selected record to be sent to the server
              console.log("Selected record to delete:", selectedRecords);

              // Send a request to the server to delete the record
              const response = await fetch(
                "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.delete_records",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ names: selectedRecords }), // Send the array of selected record names wrapped in an object
                }
              );

              // Log the response
              const result = await response.json();
              console.log("Server response:", result);

              if (result.message.status === "success") {
                // Remove the row from the table
                /*const rowElement = document
                            .querySelector(`td[data-id="${recordName}"]`)
                            .closest("tr");
                          rowElement.remove();*/

                // Show success message using SweetAlert
                Swal.fire(
                  "Deleted!",
                  `The record with name: ${recordName} has been deleted.`,
                  "success"
                );
                fetchData();
              } else if (result.message.status === "partial") {
                Swal.fire(
                  "Partial Success",
                  `Some records were deleted: ${result.message}.`,
                  "warning"
                );
              } else {
                Swal.fire(
                  "Error!",
                  "Failed to delete record. Please try again.",
                  "error"
                );
              }
            } catch (error) {
              console.error("Error deleting record:", error);
              Swal.fire(
                "Error!",
                "An unexpected error occurred. Please try again.",
                "error"
              );
            }
          }
        });
      }

      // Function to handle record submission
      async function submitRecords() {
        const table = document.querySelector("#taRecordTable tbody"); // Target the table body
        const rows = table.querySelectorAll("tr"); // Select all rows within the table body

        const recordsToUpdate = [];
        rows.forEach((row) => {
          const statusCell = row.querySelector("td:nth-child(3)"); // Assuming the 'Status' column is the first one
          const nameCell = row.querySelector("td:nth-child(1)"); // Assuming the 'Name' column is the 23rd one

          console.log("statusCell:", statusCell.textContent.trim());
          console.log("nameCell:", nameCell.textContent.trim());
          // Check if the status is not 'Pending' or 'Approved'
          if (
            statusCell.textContent.trim() !== "Pending" &&
            statusCell.textContent.trim() !== "Approved" &&
            statusCell.textContent.trim() !== "Reject"
          ) {
            recordsToUpdate.push(nameCell.textContent.trim()); // Collect the 'name' value
          }
        });

        //console.log("nameCell:",nameCell);
        console.log(recordsToUpdate);

        if (recordsToUpdate.length > 0) {
          const batchSize = 100; // Define a suitable batch size
          const batches = [];
          for (let i = 0; i < recordsToUpdate.length; i += batchSize) {
            batches.push(recordsToUpdate.slice(i, i + batchSize));
          }

          Swal.fire({
            title: `Are you sure you want to submit ${recordsToUpdate.length} record(s)?`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, submit them!",
            cancelButtonText: "No, keep them",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                for (const batch of batches) {
                  const response = await fetch(
                    "/api/method/travel_allowance.travel_allowance.doctype.travel_allowances.travel_allowances.update_status",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({ names: batch }), // Only send the record names in batches
                    }
                  );
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const result = await response.json();
                  console.log("Server response:", result);
                  if (result.message.status !== "success") {
                    throw new Error("Failed to update some records.");
                  }

                  if (result.message.status === "success") {
                    Swal.fire(
                      "Submitted!",
                      `${recordsToUpdate.length} record(s) have been updated to "Pending".`,
                      "success"
                    );
                    fetchData(); // Fetch new data if needed
                  }
                }
              } catch (error) {
                console.error("Error updating records:", error);
                Swal.fire(
                  "Error!",
                  "An unexpected error occurred. Please try again.",
                  "error"
                );
              }
            }
          });
        } else {
          Swal.fire(
            "No Records",
            "No records available for submission.",
            "info"
          );
        }
      }
      // Attach the submit function to the submit button
      document
        .querySelector(".submit-btn")
        .addEventListener("click", submitRecords);
    </script>
  </body>
</html>
